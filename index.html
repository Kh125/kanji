<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N5 Kanji Master</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for 3D flip effect and dark mode transition */
        :root {
            --flip-duration: 700ms;
        }

        /* Essential 3D properties */
        .perspective-1000 {
            perspective: 1000px;
        }
        .preserve-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        /* Card container transition */
        .card-inner {
            transition: transform var(--flip-duration);
        }

        /* Card flipped state */
        .flipped {
            transform: rotateY(180deg);
        }
        
        /* Backside rotation */
        .card-back {
            transform: rotateY(180deg);
        }

        /* Dark Mode configuration for smooth transition */
        .dark .bg-gray-900, .dark .text-white {
             transition: background-color 300ms, color 300ms;
        }
        
        /* Utility for disabling pointer events on disabled buttons in quiz */
        .quiz-disabled {
            pointer-events: none;
        }
        
        /* Styles for hidden list cell content */
        .hidden-cell-content {
            opacity: 0;
            user-select: none;
            cursor: pointer;
            transition: opacity 0.2s;
            display: block;
        }
        .reveal-cell-placeholder {
            opacity: 1;
            font-style: italic;
            cursor: pointer;
            font-size: 0.75rem; /* text-xs */
            display: block;
            color: #6b7280; /* gray-500 */
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="transition-colors duration-300">

    <div id="app-container" class="min-h-screen font-sans">
        <!-- Header -->
        <header class="py-6 shadow-md bg-white dark:bg-gray-800">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-2xl font-extrabold text-indigo-600 dark:text-indigo-400 tracking-tight">
                    N5 Kanji Master
                </h1>
                <div class="items-center space-x-4 flex">
                    <!-- Home Button (New Global Navigation) -->
                    <button id="homeButton" class="p-2 rounded-full transition duration-300 hover:bg-gray-200 dark:hover:bg-gray-700" aria-label="Go to Main Menu" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500 dark:text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                    </button>
                    <!-- Dark Mode Toggle -->
                    <button id="darkModeToggle" class="p-2 rounded-full transition duration-300 hover:bg-gray-200 dark:hover:bg-gray-700" aria-label="Toggle Dark Mode">
                        <!-- SVG will be updated by JS -->
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
            
            <!-- Progress Bar and Indicator -->
            <div class="mb-8 flex justify-between items-center text-gray-700 dark:text-gray-300">
                <p id="modeIndicator" class="text-lg font-bold">Welcome</p>
                <p id="progressIndicator" class="text-xl font-mono">N5 (104)</p>
            </div>
            
            <!-- Dynamic Controls (Start Study/Settings/Back button) -->
            <div id="modeControls" class="flex justify-center space-x-4 mb-6">
                <!-- Content injected here by JavaScript -->
            </div>

            <!-- Main Content Area -->
            <div id="mainContent" class="flex flex-col items-center">
                <!-- Content injected here by JavaScript -->
            </div>

            <!-- Navigation Buttons (Used primarily in Study View) -->
            <div id="navButtons" class="flex space-x-4 mt-10 w-full max-w-sm mx-auto" style="display: none;">
                <button id="prevButton" class="flex-1 flex items-center justify-center py-3 px-6 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white font-bold rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150 shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Previous
                </button>
                <button id="nextButton" class="flex-1 flex items-center justify-center py-3 px-6 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg">
                    Next
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                    </svg>
                </button>
            </div>

            <p id="hintText" class="mt-6 text-sm italic text-gray-500 dark:text-gray-400 text-center"></p>

        </main>
    </div>
    
    <!-- Settings Modal Overlay -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300" style="display: none;">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Quiz Settings</h2>
            <div class="space-y-6">
                <div>
                    <label for="revealDelay" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Kanji Reveal Delay (Seconds)
                    </label>
                    <input type="number" id="revealDelay" min="1" max="60" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Time the Kanji symbol is shown before the answer is revealed.</p>
                </div>
                <div>
                    <label for="reviewDelay" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Review Time (Seconds)
                    </label>
                    <input type="number" id="reviewDelay" min="1" max="60" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Time the full answer is shown before automatically advancing.</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="closeSettingsModalButton" class="py-2 px-4 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
                <button id="saveSettingsButton" class="py-2 px-4 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        // --- N5 Kanji Data structured into Lessons (104 Kanji Total) ---
        const KANJI_LESSONS = [
            {
                "lesson": 1,
                "title": "Natural Elements and Days of the Week (Kanji 1-10)",
                "kanji": [
                    {
                        "kanji": "山",
                        "meaning": "Mountain",
                        "onyomi": "サン",
                        "kunyomi": "やま",
                        "usage": [
                            "やま (やま)",
                            "富士山 (ふじさん)",
                            "登山 (とざん)"
                        ]
                    },
                    {
                        "kanji": "川",
                        "meaning": "River",
                        "onyomi": "セン",
                        "kunyomi": "かわ",
                        "usage": [
                            "かわ (かわ)",
                            "山川さん (やまかわさん)",
                            "インダス川 (いんだすがわ)"
                        ]
                    },
                    {
                        "kanji": "田",
                        "meaning": "Rice Field",
                        "onyomi": "デン",
                        "kunyomi": "た",
                        "usage": [
                            "た (た)",
                            "水田 (すいでん)",
                            "山田さん (やまださん)",
                            "油田 (ゆでん)"
                        ]
                    },
                    {
                        "kanji": "日",
                        "meaning": "Sun, Day",
                        "onyomi": "ニチ, ジツ",
                        "kunyomi": "ひ, び",
                        "usage": [
                            "ひ (ひ)",
                            "日本 (にほん)",
                            "休日 (きゅうじつ)"
                        ]
                    },
                    {
                        "kanji": "月",
                        "meaning": "Moon, Month",
                        "onyomi": "ゲツ, ガツ",
                        "kunyomi": "つき",
                        "usage": [
                            "つき (つき)",
                            "月曜日 (げつようび)",
                            "今月 (こんげつ)"
                        ]
                    },
                    {
                        "kanji": "火",
                        "meaning": "Fire",
                        "onyomi": "カ",
                        "kunyomi": "ひ",
                        "usage": [
                            "ひ (ひ)",
                            "火曜日 (かようび)",
                            "火山 (かざん)"
                        ]
                    },
                    {
                        "kanji": "水",
                        "meaning": "Water",
                        "onyomi": "スイ",
                        "kunyomi": "みず",
                        "usage": [
                            "みず (みず)",
                            "水曜日 (すいようび)",
                            "水道 (すいどう)",
                            "水田 (すいでん)"
                        ]
                    },
                    {
                        "kanji": "木",
                        "meaning": "Tree, Wood",
                        "onyomi": "ボク, モク",
                        "kunyomi": "き",
                        "usage": [
                            "き (き)",
                            "木曜日 (もくようび)"
                        ]
                    },
                    {
                        "kanji": "金",
                        "meaning": "Gold, Money, Metal",
                        "onyomi": "キン, コン",
                        "kunyomi": "かね",
                        "usage": [
                            "おかね (おかね)",
                            "金曜日 (きんようび)"
                        ]
                    },
                    {
                        "kanji": "土",
                        "meaning": "Soil, Earth, Ground",
                        "onyomi": "ド, ト",
                        "kunyomi": "つち",
                        "usage": [
                            "つち (つち)",
                            "土曜日 (どようび)",
                            "土地 (とち)"
                        ]
                    }
                ]
            },
            {
                "lesson": 2,
                "title": "Numbers (Kanji 11-20)",
                "kanji": [
                    {
                        "kanji": "一",
                        "meaning": "One",
                        "onyomi": "イチ, イツ",
                        "kunyomi": "ひと-つ",
                        "usage": [
                            "ひとつ (ひとつ)",
                            "一月 (いちがつ)",
                            "一日 (いちにち)"
                        ]
                    },
                    {
                        "kanji": "二",
                        "meaning": "Two",
                        "onyomi": "ニ",
                        "kunyomi": "ふた-つ",
                        "usage": [
                            "ふたつ (ふたつ)",
                            "二月 (にがつ)",
                            "二日 (ふつか)",
                            "二人 (ふたり)"
                        ]
                    },
                    {
                        "kanji": "三",
                        "meaning": "Three",
                        "onyomi": "サン",
                        "kunyomi": "みっ-つ",
                        "usage": [
                            "みっつ (みっつ)",
                            "三月 (さんがつ)",
                            "三日 (みっか)"
                        ]
                    },
                    {
                        "kanji": "四",
                        "meaning": "Four",
                        "onyomi": "シ",
                        "kunyomi": "よっ-つ, よん",
                        "usage": [
                            "よっつ (よっつ)",
                            "四月 (しがつ)",
                            "四日 (よっか)"
                        ]
                    },
                    {
                        "kanji": "五",
                        "meaning": "Five",
                        "onyomi": "ゴ",
                        "kunyomi": "いつ-つ",
                        "usage": [
                            "いつつ (いつつ)",
                            "五月 (ごがつ)",
                            "五日 (いつか)",
                            "五円 (ごえん)"
                        ]
                    },
                    {
                        "kanji": "六",
                        "meaning": "Six",
                        "onyomi": "ロク, リク",
                        "kunyomi": "むっ-つ",
                        "usage": [
                            "むっつ (むっつ)",
                            "六月 (ろくがつ)",
                            "六日 (むいか)",
                            "六本木 (ろっぽんぎ)"
                        ]
                    },
                    {
                        "kanji": "七",
                        "meaning": "Seven",
                        "onyomi": "シチ",
                        "kunyomi": "なな-つ",
                        "usage": [
                            "ななつ (ななつ)",
                            "七月 (しちがつ)",
                            "七日 (なのか)"
                        ]
                    },
                    {
                        "kanji": "八",
                        "meaning": "Eight",
                        "onyomi": "ハチ",
                        "kunyomi": "やっ-つ",
                        "usage": [
                            "やっつ (やっつ)",
                            "八月 (はちがつ)",
                            "八日 (ようか)",
                            "八百屋 (やおや)"
                        ]
                    },
                    {
                        "kanji": "九",
                        "meaning": "Nine",
                        "onyomi": "キュウ, ク",
                        "kunyomi": "ここの-つ",
                        "usage": [
                            "ここのつ (ここのつ)",
                            "九月 (くがつ)",
                            "九日 (ここのか)",
                            "九州 (きゅうしゅう)"
                        ]
                    },
                    {
                        "kanji": "十",
                        "meaning": "Ten",
                        "onyomi": "ジュウ, ジッ, ジュッ",
                        "kunyomi": "とお",
                        "usage": [
                            "とお (とお)",
                            "十月 (じゅうがつ)",
                            "十日 (とおか)"
                        ]
                    }
                ]
            },
            {
                "lesson": 3,
                "title": "Large Numbers, Position, and Division (Kanji 21-30)",
                "kanji": [
                    {
                        "kanji": "百",
                        "meaning": "Hundred",
                        "onyomi": "ヒャク, ビャク, ピャク",
                        "kunyomi": "なし",
                        "usage": [
                            "百 (ひゃく)",
                            "三百 (さんびゃく)",
                            "百科事典 (ひゃっかじてん)"
                        ]
                    },
                    {
                        "kanji": "千",
                        "meaning": "Thousand",
                        "onyomi": "セン, ゼン",
                        "kunyomi": "ち",
                        "usage": [
                            "千 (せん)",
                            "二千 (にせん)",
                            "千葉県 (ちばけん)"
                        ]
                    },
                    {
                        "kanji": "万",
                        "meaning": "Ten thousand",
                        "onyomi": "マン, バン",
                        "kunyomi": "なし",
                        "usage": [
                            "一万 (いちまん)",
                            "万国 (ばんこく)",
                            "万年筆 (まんねんひつ)"
                        ]
                    },
                    {
                        "kanji": "円",
                        "meaning": "Yen, Circle, Round",
                        "onyomi": "エン",
                        "kunyomi": "まる-い",
                        "usage": [
                            "円 (えん)",
                            "四万円 (よんまんえん)",
                            "円高 (えんだか)"
                        ]
                    },
                    {
                        "kanji": "年",
                        "meaning": "Year, Age",
                        "onyomi": "ネン",
                        "kunyomi": "とし",
                        "usage": [
                            "とし (とし)",
                            "来年 (らいねん)",
                            "年金 (ねんきん)",
                            "二〇〇〇年 (にせんねん)"
                        ]
                    },
                    {
                        "kanji": "上",
                        "meaning": "Above, Up, On",
                        "onyomi": "ジョウ",
                        "kunyomi": "うえ, あ-がる",
                        "usage": [
                            "うえ (うえ)",
                            "上がる (あがる)",
                            "上着 (うわぎ)"
                        ]
                    },
                    {
                        "kanji": "下",
                        "meaning": "Under, Below, Down",
                        "onyomi": "カ, ゲ",
                        "kunyomi": "した, さ-がる",
                        "usage": [
                            "した (きた)",
                            "下がる (さがる)",
                            "地下鉄 (ちかてつ)"
                        ]
                    },
                    {
                        "kanji": "中",
                        "meaning": "Middle, Inside, Center",
                        "onyomi": "チュウ, ジュウ",
                        "kunyomi": "なか",
                        "usage": [
                            "なか (なか)",
                            "一日中 (いちにちじゅう)",
                            "中学校 (ちゅうがっこう)",
                            "中心 (ちゅうしん)"
                        ]
                    },
                    {
                        "kanji": "半",
                        "meaning": "Half",
                        "onyomi": "ハン",
                        "kunyomi": "なか-ば",
                        "usage": [
                            "半分 (はんぶん)",
                            "一年半 (いちねんはん)",
                            "四時半 (よじはん)",
                            "半日 (はんにち)"
                        ]
                    },
                    {
                        "kanji": "分",
                        "meaning": "Divide, Understand, Minute",
                        "onyomi": "フン, ブン, プン",
                        "kunyomi": "わ-ける, わ-かる",
                        "usage": [
                            "分ける (わける)",
                            "分かる (わかる)",
                            "十分 (じゅうぷん)",
                            "十分 (じゅっぷん)"
                        ]
                    }
                ]
            },
            {
                "lesson": 4,
                "title": "People, Body Parts, and Power (Kanji 31-40)",
                "kanji": [
                    {
                        "kanji": "人",
                        "meaning": "Person",
                        "onyomi": "ジン, ニン",
                        "kunyomi": "ひと",
                        "usage": [
                            "ひと (person)",
                            "日本人 (Japanese)",
                            "三人 (three people)"
                        ]
                    },
                    {
                        "kanji": "子",
                        "meaning": "Child",
                        "onyomi": "シ, ス",
                        "kunyomi": "こ, こ-ども",
                        "usage": [
                            "こども (child)",
                            "女の子 (female)",
                            "親子 (parent and child)",
                            "調子 (condition)"
                        ]
                    },
                    {
                        "kanji": "女",
                        "meaning": "Woman",
                        "onyomi": "ジョ",
                        "kunyomi": "おんな",
                        "usage": [
                            "おんなのひと (woman)",
                            "女の子 (girl)",
                            "女性 (woman)"
                        ]
                    },
                    {
                        "kanji": "男",
                        "meaning": "Man",
                        "onyomi": "ダン, ナン, ケン",
                        "kunyomi": "おとこ",
                        "usage": [
                            "おとこ (man)",
                            "男の子 (boy)",
                            "男女 (man and woman)",
                            "長男 (eldest son)",
                            "だんせい (man)"
                        ]
                    },
                    {
                        "kanji": "目",
                        "meaning": "Eye",
                        "onyomi": "モク",
                        "kunyomi": "め",
                        "usage": [
                            "め (eye)",
                            "一日 (the first day)",
                            "目薬 (eye lotion)",
                            "目的 (purpose)"
                        ]
                    },
                    {
                        "kanji": "口",
                        "meaning": "Mouth",
                        "onyomi": "コウ, ク",
                        "kunyomi": "くち",
                        "usage": [
                            "くち (mouth)",
                            "入り口 (entrance)",
                            "人口 (population)",
                            "出口 (emergency exit)"
                        ]
                    },
                    {
                        "kanji": "耳",
                        "meaning": "Ear",
                        "onyomi": "ジ",
                        "kunyomi": "みみ",
                        "usage": [
                            "みみ (ear)",
                            "耳鼻科 (E.N.T clinic)"
                        ]
                    },
                    {
                        "kanji": "手",
                        "meaning": "Hand",
                        "onyomi": "シュ",
                        "kunyomi": "て",
                        "usage": [
                            "て (hand)",
                            "上手な (skillful)",
                            "手紙 (letter)"
                        ]
                    },
                    {
                        "kanji": "足",
                        "meaning": "Leg, Foot",
                        "onyomi": "ソク",
                        "kunyomi": "あし, た-りる",
                        "usage": [
                            "あし (leg)",
                            "一足 (a pair (of shoes))",
                            "足りる (to be enough)",
                            "遠足 (excursion)"
                        ]
                    },
                    {
                        "kanji": "力",
                        "meaning": "Power",
                        "onyomi": "リョク, リキ",
                        "kunyomi": "ちから",
                        "usage": [
                            "ちから (power)",
                            "水力 (water power)",
                            "体力 (physical strength)"
                        ]
                    }
                ]
            },
            {
                "lesson": 5,
                "title": "Family, Education, and Everyday Objects (Kanji 41-50)",
                "kanji": [
                    {
                        "kanji": "父",
                        "meaning": "Father",
                        "onyomi": "フ",
                        "kunyomi": "ちち",
                        "usage": [
                            "ちち (ちち)",
                            "お父さん (おとうさん)",
                            "父母 (ふぼ)"
                        ]
                    },
                    {
                        "kanji": "母",
                        "meaning": "Mother",
                        "onyomi": "ボ",
                        "kunyomi": "はは",
                        "usage": [
                            "はは (はは)",
                            "お母さん (おかあさん)",
                            "父母 (ふぼ)",
                            "母国 (ぼこく)"
                        ]
                    },
                    {
                        "kanji": "先",
                        "meaning": "Foregoing, Previous, Ahead",
                        "onyomi": "セン",
                        "kunyomi": "さき",
                        "usage": [
                            "さき (さき)",
                            "先月 (せんげつ)",
                            "先輩 (せんぱい)"
                        ]
                    },
                    {
                        "kanji": "生",
                        "meaning": "To be born, Live, Raw",
                        "onyomi": "セイ",
                        "kunyomi": "う-まれる, い-きる",
                        "usage": [
                            "生まれる (うまれる)",
                            "生きる (いきる)",
                            "先生 (せんせい)",
                            "学生 (がくせい)"
                        ]
                    },
                    {
                        "kanji": "学",
                        "meaning": "Study, Learn",
                        "onyomi": "ガク, ガッ",
                        "kunyomi": "まな-ぶ",
                        "usage": [
                            "学ぶ (まなぶ)",
                            "学生 (がくせい)",
                            "科学 (かがく)",
                            "大学 (だいがく)"
                        ]
                    },
                    {
                        "kanji": "校",
                        "meaning": "School",
                        "onyomi": "コウ",
                        "kunyomi": "",
                        "usage": [
                            "学校 (がっこう)",
                            "校長 (こうちょう)",
                            "小学校 (しょうがっこう)"
                        ]
                    },
                    {
                        "kanji": "友",
                        "meaning": "Friend",
                        "onyomi": "ユウ",
                        "kunyomi": "とも",
                        "usage": [
                            "ともだち (ともだち)",
                            "親友 (しんゆう)"
                        ]
                    },
                    {
                        "kanji": "本",
                        "meaning": "Book, Origin, Root",
                        "onyomi": "ホン",
                        "kunyomi": "もと",
                        "usage": [
                            "ほん (ほん)",
                            "日本 (にほん)",
                            "本屋 (ほんや)",
                            "山本さん (やまもとさん)"
                        ]
                    },
                    {
                        "kanji": "毎",
                        "meaning": "Every",
                        "onyomi": "マイ",
                        "kunyomi": "",
                        "usage": [
                            "毎日 (まいにち)",
                            "毎月 (まいつき)",
                            "毎年 (まいとし/まいねん)",
                            "毎朝 (まいあさ)"
                        ]
                    },
                    {
                        "kanji": "何",
                        "meaning": "What, How many",
                        "onyomi": "カ",
                        "kunyomi": "なに, なん",
                        "usage": [
                            "なに (なに)",
                            "何月 (なんがつ)",
                            "何人 (なんにん)",
                            "何時 (なんじ)"
                        ]
                    }
                ]
            },
            {
                "lesson": 6,
                "title": "Position, Directions, and Name (Kanji 51-60)",
                "kanji": [
                    {
                        "kanji": "前",
                        "meaning": "Front, Before",
                        "onyomi": "ゼン",
                        "kunyomi": "まえ",
                        "usage": [
                            "まえ (まえ)",
                            "午前 (ごぜん)"
                        ]
                    },
                    {
                        "kanji": "後",
                        "meaning": "Back, Behind, After",
                        "onyomi": "ゴ, コウ",
                        "kunyomi": "うし-ろ, あと",
                        "usage": [
                            "うしろ (うしろ)",
                            "あと (あと)",
                            "午前 (ごぜん)"
                        ]
                    },
                    {
                        "kanji": "外",
                        "meaning": "Outside, Other, Foreign",
                        "onyomi": "ガイ",
                        "kunyomi": "そと",
                        "usage": [
                            "そと (そと)",
                            "外国 (がいこく)"
                        ]
                    },
                    {
                        "kanji": "左",
                        "meaning": "Left",
                        "onyomi": "サ",
                        "kunyomi": "ひだり",
                        "usage": [
                            "ひだり (ひだり)",
                            "左側 (ひだりがわ)"
                        ]
                    },
                    {
                        "kanji": "右",
                        "meaning": "Right",
                        "onyomi": "ウ, ユウ",
                        "kunyomi": "みぎ",
                        "usage": [
                            "みぎ (みぎ)",
                            "右手 (みぎて)",
                            "右側 (みぎがわ)"
                        ]
                    },
                    {
                        "kanji": "東",
                        "meaning": "East",
                        "onyomi": "トウ",
                        "kunyomi": "ひがし",
                        "usage": [
                            "ひがし (ひがし)",
                            "東京 (とうきょう)",
                            "東洋 (とうよう)"
                        ]
                    },
                    {
                        "kanji": "西",
                        "meaning": "West",
                        "onyomi": "セイ, サイ, せい",
                        "kunyomi": "にし",
                        "usage": [
                            "にし (にし)",
                            "西口 (にしぐち)",
                            "西洋 (せいよう)"
                        ]
                    },
                    {
                        "kanji": "南",
                        "meaning": "South",
                        "onyomi": "ナン",
                        "kunyomi": "みなみ",
                        "usage": [
                            "みなみ (みなみ)",
                            "南極 (なんきょく)",
                            "南口 (みなみぐち)"
                        ]
                    },
                    {
                        "kanji": "北",
                        "meaning": "North",
                        "onyomi": "ホク, ホっ",
                        "kunyomi": "きた",
                        "usage": [
                            "きた (きた)",
                            "北口 (きたぐち)",
                            "北海道 (ほっかいどう)"
                        ]
                    },
                    {
                        "kanji": "名",
                        "meaning": "Name, Famous",
                        "onyomi": "メイ",
                        "kunyomi": "な",
                        "usage": [
                            "なまえ (なまえ)",
                            "有名 (ゆうめい)"
                        ]
                    }
                ]
            },
            {
                lesson: 7,
                title: "Transportation, Entry, and Nature (10 Kanji)",
                kanji: [
                    { kanji: '牛', meaning: 'Cow, Ox', onyomi: 'ギュウ', kunyomi: 'うし', usage: ['牛乳 (ぎゅう(にゅう))', '牛肉 (ぎゅう(にく))', '水牛 (すいぎゅう)'] },
                    { kanji: '馬', meaning: 'Horse', onyomi: 'バ', kunyomi: 'うま', usage: ['馬車 (ば(しゃ))', '木馬 (もくば)', '乗馬 (じょうば)'] },
                    { kanji: '魚', meaning: 'Fish', onyomi: 'ギョ', kunyomi: 'さかな', usage: ['魚 (さかな)', '金魚 (きんぎょ)', '人魚 (にんぎょ)'] },
                    { kanji: '貝', meaning: 'Shellfish, Shell', onyomi: '', kunyomi: 'かい', usage: ['貝 (かい)', '貝がら (かいがら)'] },
                    { kanji: '雨', meaning: 'Rain', onyomi: 'ウ', kunyomi: 'あめ', usage: ['雨 (あめ)', '大雨 (おおあめ)', '梅雨 (つゆ)'] },
                    { kanji: '天', meaning: 'Heaven, Sky', onyomi: 'テン', kunyomi: '', usage: ['天気 (てんき)', '天国 (てんごく)', '天下 (てんか)'] },
                    { kanji: '気', meaning: 'Spirit, Air', onyomi: 'キ', kunyomi: '', usage: ['天気 (てんき)', '人気 (にんき)', '気持ち (きもち)'] },
                    { kanji: '車', meaning: 'Car, Vehicle', onyomi: 'シャ', kunyomi: 'くるま', usage: ['車 (くるま)', '電車 (でんしゃ)', '自動車 (じどうしゃ)'] },
                    { kanji: '門', meaning: 'Gate', onyomi: 'モン', kunyomi: 'かど', usage: ['門 (もん)', '正門 (せいもん)', '専門 (せんもん)'] },
                    { kanji: '午', meaning: 'Noon', onyomi: 'ゴ', kunyomi: '', usage: ['午前 (ごぜん)', '午後 (ごご)', 'ひる (noon)'] },
                ]
            },
            {
                "lesson": 8,
                "title": "Size, Quality, and Time (Kanji 71-80)",
                "kanji": [
                    {
                        "kanji": "大",
                        "meaning": "Big, Large",
                        "onyomi": "ダイ, タイ",
                        "kunyomi": "おお-きい",
                        "usage": [
                            "大きい (おおきい)",
                            "大学 (だいがく)",
                            "大会 (たいかい)"
                        ]
                    },
                    {
                        "kanji": "小",
                        "meaning": "Small, Little",
                        "onyomi": "ショウ",
                        "kunyomi": "ちい-さい",
                        "usage": [
                            "小さい (ちいさい)",
                            "小川 (おがわ)",
                            "小学校 (しょうがっこう)"
                        ]
                    },
                    {
                        "kanji": "高",
                        "meaning": "High, Tall, Expensive",
                        "onyomi": "コウ",
                        "kunyomi": "たか-い",
                        "usage": [
                            "高い (たかい)",
                            "高校生 (こうこうせい)",
                            "円高 (えんだか)"
                        ]
                    },
                    {
                        "kanji": "安",
                        "meaning": "Cheap, Safe, Peaceful",
                        "onyomi": "アン",
                        "kunyomi": "やす-い",
                        "usage": [
                            "やすい (やすい)",
                            "あんぜん (あんぜん)",
                            "安心する (あんしんする)"
                        ]
                    },
                    {
                        "kanji": "新",
                        "meaning": "New",
                        "onyomi": "シン",
                        "kunyomi": "あたら-しい",
                        "usage": [
                            "新しい (あたらしい)",
                            "新聞 (しんぶん)",
                            "新人 (しんじん)"
                        ]
                    },
                    {
                        "kanji": "古",
                        "meaning": "Old",
                        "onyomi": "コ",
                        "kunyomi": "ふる-い",
                        "usage": [
                            "古い (ふるい)",
                            "中古車 (ちゅうこしゃ)"
                        ]
                    },
                    {
                        "kanji": "長",
                        "meaning": "Long, Chief, Head",
                        "onyomi": "チョウ",
                        "kunyomi": "なが-い",
                        "usage": [
                            "長い (ながい)",
                            "社長 (しゃちょう)",
                            "校長 (こうちょう)"
                        ]
                    },
                    {
                        "kanji": "多",
                        "meaning": "Many, Much",
                        "onyomi": "タ",
                        "kunyomi": "おお-い",
                        "usage": [
                            "多い (おおい)",
                            "多少 (たしょう)",
                            "多数決 (たすうけつ)"
                        ]
                    },
                    {
                        "kanji": "少",
                        "meaning": "Few, Little",
                        "onyomi": "ショウ",
                        "kunyomi": "すく-ない, すこ-し",
                        "usage": [
                            "少ない (すくない)",
                            "少年 (しょうねん)",
                            "少女 (しょうじょ)"
                        ]
                    },
                    {
                        "kanji": "早",
                        "meaning": "Early, Fast",
                        "onyomi": "ソウ",
                        "kunyomi": "はや-い",
                        "usage": [
                            "早い (はやい)",
                            "早朝 (そうちょう)",
                            "早送り (はやおくり)"
                        ]
                    }
                ]
            },
            {
                "lesson": 9,
                "title": "Movement, Senses, and Actions (Kanji 81-90)",
                "kanji": [
                    {
                        "kanji": "行",
                        "meaning": "Go, Line, Act",
                        "onyomi": "コウ, ギョウ",
                        "kunyomi": "い-く, おこな-う",
                        "usage": [
                            "行く (いく)",
                            "行き方 (いきかた)",
                            "銀行 (ぎんこう)",
                            "三行目 (さんぎょうめ)"
                        ]
                    },
                    {
                        "kanji": "来",
                        "meaning": "Come, Next",
                        "onyomi": "ライ",
                        "kunyomi": "く-る, こ-ない, き-ます",
                        "usage": [
                            "来る (くる)",
                            "来年 (らいねん)",
                            "来週 (らいしゅう)",
                            "将来 (しょうらい)"
                        ]
                    },
                    {
                        "kanji": "食",
                        "meaning": "Eat, Food",
                        "onyomi": "ショク",
                        "kunyomi": "た-べる",
                        "usage": [
                            "食べる (たべる)",
                            "外食 (がいしょく)",
                            "食料品 (しょくりょうひん)",
                            "食堂 (しょくどう)"
                        ]
                    },
                    {
                        "kanji": "見",
                        "meaning": "See, Look at, Show",
                        "onyomi": "ケン",
                        "kunyomi": "み-る",
                        "usage": [
                            "見る (みる)",
                            "見せる (みせる)",
                            "見学する (けんがくする)",
                            "意見 (いけん)"
                        ]
                    },
                    {
                        "kanji": "入",
                        "meaning": "Enter, Put in",
                        "onyomi": "ニュウ",
                        "kunyomi": "はい-る, い-れる",
                        "usage": [
                            "入る (はいる)",
                            "入れる (いれる)",
                            "入口 (いりぐち)",
                            "入学する (にゅうがくする)"
                        ]
                    },
                    {
                        "kanji": "出",
                        "meaning": "Go out, Take out, Exit",
                        "onyomi": "シュツ",
                        "kunyomi": "で-る, だ-す",
                        "usage": [
                            "出る (でる)",
                            "出す (だす)",
                            "出口 (でぐち)",
                            "提出する (ていしゅつする)"
                        ]
                    },
                    {
                        "kanji": "立",
                        "meaning": "Stand, Establish",
                        "onyomi": "リツ",
                        "kunyomi": "た-つ",
                        "usage": [
                            "立つ (たつ)",
                            "立食パーティー (りっしょくパーティー)",
                            "国立大学 (こくりつだいがく)"
                        ]
                    },
                    {
                        "kanji": "書",
                        "meaning": "Write, Book",
                        "onyomi": "ショ",
                        "kunyomi": "か-く",
                        "usage": [
                            "書く (かく)",
                            "読書 (どくしょ)",
                            "下書き (したがき)",
                            "辞書 (じしょ)"
                        ]
                    },
                    {
                        "kanji": "言",
                        "meaning": "Say, Word, Language",
                        "onyomi": "ゲン, ゴン",
                        "kunyomi": "い-う",
                        "usage": [
                            "言う (いう)",
                            "言語 (げんご)",
                            "伝言 (でんごん)"
                        ]
                    },
                    {
                        "kanji": "飲",
                        "meaning": "Drink, Beverage",
                        "onyomi": "イン",
                        "kunyomi": "の-む",
                        "usage": [
                            "飲む (のむ)",
                            "飲み物 (のみもの)",
                            "飲食店 (いんしょくてん)"
                        ]
                    }
                ]
            },
            {
                "lesson": 10,
                "title": "Conversation, Time, and Travel (Kanji 91-100)",
                "kanji": [
                    {
                        "kanji": "話",
                        "meaning": "Speak, Talk, Story",
                        "onyomi": "ワ",
                        "kunyomi": "はな-す, はなし",
                        "usage": [
                            "話す (はなす)",
                            "話 (はなし)",
                            "電話 (でんわ)",
                            "会話 (かいわ)"
                        ]
                    },
                    {
                        "kanji": "読",
                        "meaning": "Read",
                        "onyomi": "ドク",
                        "kunyomi": "よ-む",
                        "usage": [
                            "読む (よむ)",
                            "読書 (どくしょ)"
                        ]
                    },
                    {
                        "kanji": "語",
                        "meaning": "Word, Language, Talk",
                        "onyomi": "ゴ",
                        "kunyomi": "かた-る",
                        "usage": [
                            "語る (かたる)",
                            "日本語 (にほんご)",
                            "中国語 (ちゅうごくご)",
                            "外国語 (がいこくご)"
                        ]
                    },
                    {
                        "kanji": "間",
                        "meaning": "Between, Interval, Time",
                        "onyomi": "カン",
                        "kunyomi": "あいだ, ま",
                        "usage": [
                            "間 (あいだ)",
                            "時間 (じかん)",
                            "間に合う (まにあう)"
                        ]
                    },
                    {
                        "kanji": "聞",
                        "meaning": "Listen, Hear, Ask",
                        "onyomi": "ブン",
                        "kunyomi": "き-く, き-こえる",
                        "usage": [
                            "聞く (きく)",
                            "聞こえる (きこえる)",
                            "新聞 (しんぶん)"
                        ]
                    },
                    {
                        "kanji": "買",
                        "meaning": "Buy",
                        "onyomi": "バイ",
                        "kunyomi": "か-う",
                        "usage": [
                            "買う (かう)",
                            "買い物 (かいもの)",
                            "売買する (ばいばいする)"
                        ]
                    },
                    {
                        "kanji": "休",
                        "meaning": "Rest, Day off",
                        "onyomi": "キュウ",
                        "kunyomi": "やす-む",
                        "usage": [
                            "休む (やすむ)",
                            "休み (やすみ)",
                            "休日 (きゅうじつ)",
                            "夏休み (なつやすみ)"
                        ]
                    },
                    {
                        "kanji": "時",
                        "meaning": "Time, Hour",
                        "onyomi": "ジ",
                        "kunyomi": "じかん",
                        "usage": [
                            "時 (とき)",
                            "一時間 (いちじかん)",
                            "時計 (とけい)"
                        ]
                    },
                    {
                        "kanji": "週",
                        "meaning": "Week",
                        "onyomi": "シュウ",
                        "kunyomi": "",
                        "usage": [
                            "一週間 (いっしゅうかん)",
                            "来週 (らいしゅう)",
                            "今週 (こんしゅう)",
                            "先週 (せんしゅう)"
                        ]
                    },
                    {
                        "kanji": "道",
                        "meaning": "Street, Road, Way",
                        "onyomi": "ドウ",
                        "kunyomi": "みち",
                        "usage": [
                            "道 (みち)",
                            "水道 (すいどう)",
                            "書道 (しょどう)"
                        ]
                    }
                ]
            },
            {
                "lesson": 11,
                "title": "Organizations, Places, and Objects (Kanji 101-110)",
                "kanji": [
                    {
                        "kanji": "今",
                        "meaning": "Now",
                        "onyomi": "コン",
                        "kunyomi": "いま",
                        "usage": [
                            "いま (いま)",
                            "今日 (きょう)",
                            "今月 (こんげつ)"
                        ]
                    },
                    {
                        "kanji": "会",
                        "meaning": "Meet, Gather, Society",
                        "onyomi": "カイ",
                        "kunyomi": "あ-う",
                        "usage": [
                            "会う (あう)",
                            "会話 (かいわ)",
                            "新年会 (しんねんかい)"
                        ]
                    },
                    {
                        "kanji": "社",
                        "meaning": "Company, Shrine, Society",
                        "onyomi": "シャ, ジャ",
                        "kunyomi": "",
                        "usage": [
                            "会社 (かいしゃ)",
                            "社長 (しゃちょう)",
                            "神社 (じんじゃ)"
                        ]
                    },
                    {
                        "kanji": "店",
                        "meaning": "Shop, Store",
                        "onyomi": "テン",
                        "kunyomi": "みせ",
                        "usage": [
                            "店 (みせ)",
                            "店員 (てんいん)",
                            "売店 (ばいてん)"
                        ]
                    },
                    {
                        "kanji": "駅",
                        "meaning": "Station",
                        "onyomi": "エキ",
                        "kunyomi": "",
                        "usage": [
                            "駅 (えき)",
                            "駅員 (えきいん)"
                        ]
                    },
                    {
                        "kanji": "花",
                        "meaning": "Flower",
                        "onyomi": "カ",
                        "kunyomi": "はな",
                        "usage": [
                            "花 (はな)",
                            "花火 (はなび)",
                            "生け花 (いけばな)"
                        ]
                    },
                    {
                        "kanji": "国",
                        "meaning": "Country, Nation",
                        "onyomi": "コク, ごク",
                        "kunyomi": "くに",
                        "usage": [
                            "国 (くに)",
                            "外国 (がいこく)",
                            "国際会議 (こくさいかいぎ)"
                        ]
                    },
                    {
                        "kanji": "白",
                        "meaning": "White",
                        "onyomi": "ハク",
                        "kunyomi": "しろ, しろ-い",
                        "usage": [
                            "白い (しろい)",
                            "白雪 (しらゆき)",
                            "白紙 (はくし)"
                        ]
                    },
                    {
                        "kanji": "空",
                        "meaning": "Sky, Empty, Air",
                        "onyomi": "クウ",
                        "kunyomi": "そら, ぞら",
                        "usage": [
                            "空 (そら)",
                            "空 (から)",
                            "空港 (くうこう)"
                        ]
                    },
                    {
                        "kanji": "電",
                        "meaning": "Electricity, Lightning",
                        "onyomi": "デン",
                        "kunyomi": "",
                        "usage": [
                            "電気 (でんき)",
                            "電車 (でんしゃ)",
                            "電話 (でんわ)",
                            "電灯 (でんとう)"
                        ]
                    }
                ]
            }
        ];
        
        // Flattened list of ALL kanji
        const ALL_KANJI = KANJI_LESSONS.flatMap(lesson => lesson.kanji);

        // --- State Management ---
        let currentView = 'mode-select'; // 'mode-select', 'lesson-select', or 'study'
        let currentMode = 'list'; // 'list', 'flashcard', or 'quiz'
        let currentKanjiIndex = 0;
        let isCardFlipped = false;
        let isDarkMode = true;
        let quizFeedback = null;
        let isMeaningHidden = false; // NEW state for flashcard mode
        let bookmarkedKanji = []; // Stores kanji characters (e.g., ['一', '人'])

        // Lesson state for all modes
        let selectedLessons = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
        let studyKanjiList = ALL_KANJI; 
        
        // Quiz interval state
        let quizIntervalId = null;
        let timerDuration = 0; // Total duration of the current phase (Reveal or Review)
        let timerStartTime = 0; // Start time of the current *unpaused* countdown
        let isTimerPaused = false; // NEW: Timer pause state
        let pauseTime = 0; // Time remaining in milliseconds when paused
        
        // User Settings (Custom intervals)
        let userSettings = {
            revealDelay: 5, 
            reviewDelay: 4, 
        };
        
        // List View Settings (NEW: Column visibility state)
        let listVisibility = {
            meaning: true,
            onyomi: true,
            kunyomi: true,
        };


        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const homeButton = document.getElementById('homeButton');
        const modeControls = document.getElementById('modeControls');
        const mainContent = document.getElementById('mainContent');
        const progressIndicator = document.getElementById('progressIndicator');
        const modeIndicator = document.getElementById('modeIndicator');
        const hintText = document.getElementById('hintText');
        const navButtons = document.getElementById('navButtons');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        
        // Settings Modal elements
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalButton = document.getElementById('closeSettingsModalButton');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const revealDelayInput = document.getElementById('revealDelay');
        const reviewDelayInput = document.getElementById('reviewDelay');


        // --- Utility Functions ---

        const BOOKMARKS_KEY = 'n5KanjiBookmarks';

        function loadBookmarks() {
            try {
                const storedBookmarks = localStorage.getItem(BOOKMARKS_KEY);
                bookmarkedKanji = storedBookmarks ? JSON.parse(storedBookmarks) : [];
            } catch (e) {
                console.error("Could not load bookmarks from local storage:", e);
                bookmarkedKanji = [];
            }
        }

        function saveBookmarks() {
            try {
                localStorage.setItem(BOOKMARKS_KEY, JSON.stringify(bookmarkedKanji));
            } catch (e) {
                console.error("Could could not save bookmarks to local storage:", e);
            }
        }

        window.toggleBookmark = function(kanji) {
            const index = bookmarkedKanji.indexOf(kanji);
            if (index > -1) {
                bookmarkedKanji.splice(index, 1); // Remove
                showToast('Removed from Bookmarks', 'bg-red-500');
            } else {
                bookmarkedKanji.push(kanji); // Add
                showToast('Bookmarked!', 'bg-green-500');
            }
            saveBookmarks();
            renderApp(); // Re-render to update the bookmark icon status
        }
        
        function showToast(message, bgColor) {
             const toastDiv = document.createElement('div');
             toastDiv.className = `fixed top-4 right-4 ${bgColor} text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300`;
             toastDiv.textContent = message;
             document.body.appendChild(toastDiv);
             setTimeout(() => {
                 toastDiv.style.opacity = '0';
                 setTimeout(() => toastDiv.remove(), 300);
             }, 2500);
        }

        // Simple shuffle function
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Compiles the list of kanji for the current study session based on selectedLessons.
         */
        function compileStudyList() {
            let filteredKanji = [];
            
            // Check for "Bookmarked Cards" selection (lesson='bookmarks' is a string)
            const studyingBookmarks = selectedLessons.includes('bookmarks'); 

            if (studyingBookmarks) {
                // Filter ALL kanji to include only those in the bookmarkedKanji array
                filteredKanji = ALL_KANJI.filter(k => bookmarkedKanji.includes(k.kanji));
            } else {
                // Standard lesson filtering
                filteredKanji = KANJI_LESSONS
                    .filter(lesson => selectedLessons.includes(lesson.lesson))
                    .flatMap(lesson => lesson.kanji);
            }
            
            // SHUFFLE only for Flashcard and Quiz
            if (currentMode === 'quiz' || currentMode === 'flashcard') {
                studyKanjiList = shuffleArray(filteredKanji);
            } else {
                // For list view, preserve original lesson order
                studyKanjiList = filteredKanji;
            }

            currentKanjiIndex = 0;
        }

        // --- Quiz Timer/Interval Logic ---
        
        /**
         * Stops all running quiz timers/intervals.
         */
        function stopQuizTimers() {
            clearInterval(quizIntervalId);
            quizIntervalId = null;
            isTimerPaused = false;
        }

        /**
         * Pauses the current running timer.
         */
        window.pauseTimer = function() {
            if (quizIntervalId) {
                // 1. Calculate remaining time precisely
                const elapsed = Date.now() - timerStartTime;
                pauseTime = timerDuration - elapsed; 
                
                stopQuizTimers();
                isTimerPaused = true;
                
                // 2. Immediately update the display to show the correct remaining time
                const timerDisplay = document.getElementById('quizTimerDisplay');
                if (timerDisplay) {
                     // Ensure time doesn't show negative
                     const displayTime = Math.max(0, pauseTime / 1000);
                     timerDisplay.textContent = `${displayTime.toFixed(1)}s (PAUSED)`;
                }

                hintText.textContent = `Timer paused. Click Resume to continue.`;
                renderApp(); // Rerender to show Pause/Resume button state
            }
        }
        
        /**
         * Toggles the timer state (Pause/Resume).
         */
        window.togglePauseResume = function() {
            if (isTimerPaused) {
                // Resume
                isTimerPaused = false;
                
                // Get the function to call when the timer finishes (reveal or next)
                const onCompleteFunction = quizFeedback ? handleNext : handleRevealAnswer;
                
                // Start interval using the pauseTime as the remaining duration
                startQuizInterval(pauseTime, onCompleteFunction);
                
                if (quizFeedback) {
                     hintText.textContent = `Reviewing answer. Advancing to next card in ${(pauseTime / 1000).toFixed(1)} seconds.`;
                } else {
                     hintText.textContent = `Recalling... Answer will reveal in ${(pauseTime / 1000).toFixed(1)} seconds.`;
                }
            } else {
                // Pause
                pauseTimer();
            }
            renderApp();
        }

        /**
         * Starts the continuous countdown display and checks for phase completion.
         */
        function startQuizInterval(durationMs, onComplete) {
            stopQuizTimers();
            
            // Set the full duration of the countdown (e.g., 5000ms)
            timerDuration = durationMs;
            
            // Determine the total duration of the original phase (needed for calculating timePassed on resume)
            let originalPhaseDuration;
            if (onComplete === handleRevealAnswer) {
                originalPhaseDuration = userSettings.revealDelay * 1000;
            } else {
                originalPhaseDuration = userSettings.reviewDelay * 1000;
            }

            // Calculate how much time has passed since the start of the original phase
            // If durationMs === originalPhaseDuration, then timePassed is 0 (new card start)
            // If durationMs < originalPhaseDuration, then timePassed is the elapsed time (resume)
            const timePassed = originalPhaseDuration - durationMs;
            
            // FIX: Set timerStartTime to compensate for the time already passed.
            // This ensures elapsed = Date.now() - timerStartTime correctly measures time left.
            timerStartTime = Date.now() - timePassed;

            const timerDisplay = document.getElementById('quizTimerDisplay');
            if (timerDisplay) {
                // Initial update
                timerDisplay.textContent = `${(durationMs / 1000).toFixed(1)}s`;
            }

            quizIntervalId = setInterval(() => {
                // Recalculate remaining time relative to the calculated start time
                const elapsed = Date.now() - timerStartTime;
                const remaining = timerDuration - elapsed;
                
                if (remaining <= 0) {
                    stopQuizTimers();
                    if (onComplete) onComplete();
                    return;
                }

                if (timerDisplay) {
                    timerDisplay.textContent = `${(remaining / 1000).toFixed(1)}s`;
                }
            }, 100); 
        }
        
        /**
         * Starts the Reveal phase countdown.
         */
        function startRevealTimer() {
            const durationMs = userSettings.revealDelay * 1000;
            startQuizInterval(durationMs, handleRevealAnswer);
            hintText.textContent = `Recalling... Answer will reveal in ${userSettings.revealDelay} seconds.`;
        }

        /**
         * Starts the Review phase countdown (auto-advance).
         */
        function startReviewTimer() {
            const durationMs = userSettings.reviewDelay * 1000;
            startQuizInterval(durationMs, handleNext);
            hintText.textContent = `Reviewing answer. Advancing to next card in ${userSettings.reviewDelay} seconds.`;
        }
        

        // --- Render Functions (View Controllers) ---

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            renderApp();
        }
        
        function handleGoToMain() {
            stopQuizTimers();
            currentMode = 'list';
            currentView = 'mode-select';
            quizFeedback = null;
            isCardFlipped = false;
            currentKanjiIndex = 0;
            isMeaningHidden = false; // Reset flashcard state
            // Reset List Visibility on leaving List View
            listVisibility = {meaning: true, onyomi: true, kunyomi: true};
            renderApp();
        }

        function renderApp() {
            // 1. Dark Mode setup
            appContainer.className = isDarkMode
                ? 'dark bg-gray-900 text-white min-h-screen font-sans transition-colors duration-300'
                : 'bg-gray-50 text-gray-900 min-h-screen font-sans transition-colors duration-300';
            document.body.classList.toggle('dark', isDarkMode);
            
            // 2. Clear dynamic elements
            modeControls.innerHTML = '';
            mainContent.innerHTML = '';
            navButtons.style.display = 'none';
            
            // Only stop timers if changing away from study view, otherwise let the logic handle it
            if (currentView !== 'study') {
                 stopQuizTimers();
            }
            
            // 2.5. Control Home Button visibility
            homeButton.style.display = currentView !== 'mode-select' ? 'block' : 'none';
            
            // 3. Render view-specific content
            if (currentView === 'mode-select') {
                renderModeSelect();
            } else if (currentView === 'lesson-select') {
                renderLessonSelectPage();
            } else if (currentView === 'study') {
                renderStudyView();
            }
            
            // 4. Update Header/Progress
            const totalKanji = ALL_KANJI.length;
            progressIndicator.textContent = `N5 (${totalKanji})`;

            // 5. Dark Mode SVG
            darkModeToggle.innerHTML = isDarkMode ? `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
            ` : `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            `;
        }

        function renderModeSelect() {
            modeIndicator.textContent = 'Select Study Mode';
            hintText.textContent = 'Choose how you want to interact with the N5 kanji list.';

            const modeCards = [
                { mode: 'list', title: 'List View', icon: '📝', description: 'See all kanji details, readings, and usage examples in a clear table format.' },
                { mode: 'flashcard', title: 'Flashcard View', icon: '🃏', description: 'Flip through individual kanji cards for focused practice, lesson by lesson.' },
                { mode: 'quiz', title: 'Automated Quiz', icon: '⏱️', description: 'Test your recall using timed intervals for reveal and review, based on your settings.' },
            ];

            const cardsHtml = modeCards.map(card => `
                <button onclick="handleModeSelect('${card.mode}')" class="flex flex-col items-center p-6 bg-white dark:bg-gray-800 rounded-xl shadow-xl hover:shadow-2xl hover:scale-[1.02] transition transform duration-300 w-full text-left border-t-4 border-indigo-500">
                    <span class="text-5xl mb-3">${card.icon}</span>
                    <h3 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">${card.title}</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">${card.description}</p>
                </button>
            `).join('');

            mainContent.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">${cardsHtml}</div>`;
        }

        function renderLessonSelectPage() {
            const isFlashcardMode = currentMode === 'flashcard';
            const isQuizMode = currentMode === 'quiz';
            
            modeIndicator.textContent = `${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)} Mode Selection`;
            hintText.textContent = (isFlashcardMode || isQuizMode)
                ? 'Select multiple lessons for a shuffled study session (Quiz or Flashcard), or use the Settings button.'
                : 'Select a single lesson to begin browsing in List View.';

            const inputType = 'checkbox';
            const inputName = 'lessonSelection';
            
            // --- NEW: Bookmarked Cards Option ---
            const hasBookmarks = bookmarkedKanji.length > 0;
            const isBookmarkedSelected = selectedLessons.includes('bookmarks');
            
            let bookmarkOptionHtml = '';
            // Only show bookmark option for Flashcard and Quiz modes
            if ((isFlashcardMode || isQuizMode) && hasBookmarks) {
                bookmarkOptionHtml = `
                    <label class="flex items-center space-x-3 p-3 bg-red-100 dark:bg-red-900 rounded-lg cursor-pointer hover:bg-red-200 dark:hover:bg-red-800 transition">
                        <input type="${inputType}" 
                               name="${inputName}"
                               data-lesson="bookmarks" 
                               class="h-5 w-5 text-red-600 rounded border-gray-300 focus:ring-red-500 lesson-checkbox"
                               ${isBookmarkedSelected ? 'checked' : ''}>
                        <span class="text-red-900 dark:text-red-300 font-bold">
                            Bookmarked Cards (${bookmarkedKanji.length} Kanji)
                        </span>
                    </label>
                `;
            }

            const lessonCheckboxesHtml = KANJI_LESSONS.map(lesson => {
                const isChecked = selectedLessons.includes(lesson.lesson);

                return `
                    <label class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                        <input type="${inputType}" 
                               name="${inputName}"
                               data-lesson="${lesson.lesson}" 
                               class="h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 lesson-checkbox"
                               ${isChecked ? 'checked' : ''}>
                        <span class="text-gray-900 dark:text-white font-medium">
                            Lesson ${lesson.lesson}: ${lesson.title}
                        </span>
                    </label>
                `;
            }).join('');
            
            // Calculate selected Kanji count
            const selectedKanjiCount = isBookmarkedSelected
                ? bookmarkedKanji.length
                : KANJI_LESSONS
                    .filter(lesson => selectedLessons.includes(lesson.lesson))
                    .flatMap(lesson => lesson.kanji)
                    .length;

            
            // Build Controls
            const settingsBtnHtml = isQuizMode ? `
                <button onclick="renderSettingsModal()" class="py-2 px-4 text-sm font-semibold rounded-lg bg-gray-500 hover:bg-gray-600 text-white shadow-md transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.5.342 1.174.298 1.724-.066z" />
                    </svg>
                    Settings
                </button>
            ` : '';
            
            modeControls.innerHTML = `
                ${settingsBtnHtml}
                <button id="startStudyButton" onclick="handleLessonSelectConfirm()" class="py-2 px-4 text-sm font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white shadow-md transition duration-150">
                    Start ${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)} (${selectedKanjiCount} Kanji)
                </button>
            `;


            mainContent.innerHTML = `
                <div class="w-full max-w-lg">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Select Lessons</h2>
                    
                    <div class="flex space-x-2 mb-4">
                         <button onclick="handleSelectAll(true)" class="flex-1 py-2 px-4 text-sm rounded-lg bg-blue-500 hover:bg-blue-600 text-white transition duration-150">
                            Select All Lessons
                        </button>
                        <button onclick="handleSelectAll(false)" class="flex-1 py-2 px-4 text-sm rounded-lg bg-gray-500 hover:bg-gray-600 text-white transition duration-150">
                            Unselect All
                        </button>
                    </div>

                    <div id="lessonCheckboxes" class="grid grid-cols-2 gap-4 max-h-96 overflow-y-auto p-2 bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                        ${bookmarkOptionHtml}
                        ${lessonCheckboxesHtml}
                    </div>
                </div>
            `;
            
            // Attach live event listener to update the start button count and handle bookmark exclusivity
            document.querySelectorAll('.lesson-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateStartButtonCount);
            });
            updateStartButtonCount(); // Initial count load
        }
        
        function updateStartButtonCount() {
            const checkboxes = document.querySelectorAll('.lesson-checkbox');
            let currentSelectedLessons = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.lesson); 

            let currentSelectedKanjiCount;
            const studyingBookmarks = currentSelectedLessons.includes('bookmarks');
            
            // Logic for mutual exclusion between lessons and bookmarks
            checkboxes.forEach(cb => {
                if (cb.dataset.lesson === 'bookmarks') {
                    // This is the bookmarks checkbox
                    cb.disabled = false;
                } else {
                    // Lesson checkboxes are disabled if bookmarks is selected
                    cb.disabled = studyingBookmarks;
                }
            });

            if (studyingBookmarks) {
                currentSelectedKanjiCount = bookmarkedKanji.length;
            } else {
                // Normal lesson filtering (convert non-bookmark selections back to numbers)
                const numericSelections = currentSelectedLessons.map(l => parseInt(l)).filter(n => !isNaN(n));
                currentSelectedKanjiCount = KANJI_LESSONS
                    .filter(lesson => numericSelections.includes(lesson.lesson))
                    .flatMap(lesson => lesson.kanji)
                    .length;
            }
            
            const startButton = document.getElementById('startStudyButton');
            if (startButton) {
                 startButton.innerHTML = `Start ${currentMode.charAt(0).toUpperCase() + currentMode.slice(1)} (${currentSelectedKanjiCount} Kanji)`;
                 startButton.disabled = currentSelectedKanjiCount === 0;
            }
        }

        function handleSelectAll(select) {
            const checkboxes = document.querySelectorAll('.lesson-checkbox');
            checkboxes.forEach(cb => {
                // Ensure 'Select All' doesn't select bookmarks unless specifically intended 
                if (cb.dataset.lesson !== 'bookmarks') {
                    cb.checked = select;
                }
            });
            
            // FIX: Check if the bookmark element exists before trying to access it.
            const bookmarkCheckbox = document.querySelector('[data-lesson="bookmarks"]');
            
            if (bookmarkCheckbox) {
                 // If selecting all, we need to uncheck 'bookmarks' manually to prevent exclusivity conflict.
                 bookmarkCheckbox.checked = false;
            }

            updateStartButtonCount();
        }


        function renderStudyView() {
            const totalKanji = studyKanjiList.length;
            const currentKanji = studyKanjiList[currentKanjiIndex] || {};
            
            if (totalKanji === 0) {
                 // Handle empty bookmark list gracefully
                 showToast('The selected study list is empty. Returning to selection.', 'bg-red-600');
                 currentView = 'lesson-select';
                 renderApp();
                 return;
            }
            
            modeIndicator.textContent = currentMode === 'quiz' ? 'Automated Quiz' : 
                                       (currentMode === 'flashcard' ? 'Flashcard Review' : 'Kanji List');
            
            // UPDATED PROGRESS INDICATOR
            if (currentMode === 'list') {
                 // In List Mode, show current lesson progress (unchanged)
                 const currentLesson = KANJI_LESSONS.find(l => l.lesson === selectedLessons[0]) || {title: 'Mixed Lessons'};
                 progressIndicator.textContent = currentLesson.title.split('(')[0].trim();
            } else {
                 // Flashcard and Quiz Mode: Show card number / total count
                 progressIndicator.textContent = `${currentKanjiIndex + 1} / ${totalKanji}`;
            }

            // 1. Render main content based on mode
            if (currentMode === 'list') {
                renderListView(studyKanjiList);
            } else if (currentMode === 'flashcard') {
                renderFlashcard(currentKanji);
            } else {
                renderQuizMode(currentKanji);
            }
            
            // 2. Setup navigation buttons
            navButtons.style.display = 'flex';
            
            // Label buttons based on mode
            if (currentMode === 'list') {
                prevButton.textContent = 'Previous Lesson';
                nextButton.textContent = 'Next Lesson';
            } else if (currentMode === 'flashcard') {
                prevButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                        </svg>Previous Card`;
                nextButton.innerHTML = `Next Card<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                        </svg>`;
                hintText.textContent = !isCardFlipped ? 'Tap the card to reveal the readings and usage.' : '';
            } else {
                // Quiz Mode - Navigation is disabled because it's automated
                prevButton.textContent = 'Exit Quiz'; 
                nextButton.textContent = 'Quiz Active';
                nextButton.classList.add('opacity-50', 'pointer-events-none');
                prevButton.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'dark:bg-gray-700', 'dark:hover:bg-gray-600', 'text-gray-800', 'dark:text-white');
                prevButton.classList.add('bg-red-600', 'hover:bg-red-700', 'text-white');
                prevButton.disabled = false;
            }
            
            if (currentMode !== 'quiz') {
                 prevButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'text-white');
                 prevButton.classList.add('bg-gray-200', 'hover:bg-gray-300', 'dark:bg-gray-700', 'dark:hover:bg-gray-600', 'text-gray-800', 'dark:text-white');
                 nextButton.classList.remove('opacity-50', 'pointer-events-none');
                 nextButton.disabled = false;
            }

            // 3. Start interval if in Quiz Mode
            if (currentMode === 'quiz') {
                // Only start timer if not already paused and not already revealed
                if (!quizFeedback && !isTimerPaused) {
                    startRevealTimer();
                } else if (quizFeedback && !isTimerPaused) {
                    // Resume review phase if revealed and not paused
                    startReviewTimer();
                } else if (isTimerPaused) {
                    // Do nothing, but ensure buttons are rendered correctly in quiz mode
                    hintText.textContent = `Timer paused. Click Resume to continue.`;
                }
            }
        }

        // --- Core Content Renderers ---
        
        /**
         * Toggles the global visibility of a column in the List View.
         * @param {string} columnKey 'meaning', 'onyomi', or 'kunyomi'
         */
        window.toggleListColumn = function(columnKey) {
            listVisibility[columnKey] = !listVisibility[columnKey];
            renderApp();
        }

        /**
         * Toggles the visibility of the content within a single cell.
         * @param {Event} event The click event
         */
        window.toggleCellVisibility = function(event) {
            event.stopPropagation();
            const target = event.currentTarget;
            const content = target.querySelector('.hidden-cell-content');
            const placeholder = target.querySelector('.reveal-cell-placeholder');

            if (content && placeholder) {
                 // Check current state based on class presence
                 const isContentHidden = content.classList.contains('hidden-cell-content');
                 
                 if (isContentHidden) {
                     content.classList.remove('hidden-cell-content');
                     content.classList.add('visible-cell-content');
                     placeholder.style.display = 'none';
                 } else {
                     // This case is generally not needed if the column is globally visible
                     // but included for completeness if user clicks already revealed content
                     content.classList.add('hidden-cell-content');
                     content.classList.remove('visible-cell-content');
                     placeholder.style.display = 'block';
                 }
            }
        }


        function renderListView(kanjiList) {
             const isBookmarkedStudy = selectedLessons.includes('bookmarks');
             const lessonData = KANJI_LESSONS.find(l => l.lesson === selectedLessons[0]) || {title: 'Mixed Lessons'};
             const lessonTitle = isBookmarkedStudy ? `Bookmarked Kanji (${kanjiList.length} total)` : lessonData.title;

             const getVisibilityIcon = (key) => {
                 return listVisibility[key] 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.82L9.172 14.127a3 3 0 01-3.136-3.136l4.703-4.703a3 3 0 013.136-3.136l4.703 4.703a3 3 0 01-3.136 3.136l-4.703 4.703zm-2.083-2.083l-4.703-4.703" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 18s5.5-4 5.5-7.5S15.207 4.5 12 4.5 6.5 8.5 6.5 11.5 6.5 18 12 18z" /></svg>`;
             }

             const generateCellContent = (value, key) => {
                 const isHidden = !listVisibility[key];
                 const cellContent = key === 'usage' 
                    ? `<ul class="list-disc list-inside space-y-1">${value.map(u => `<li>${u}</li>`).join('')}</ul>`
                    : value;
                 
                 if (!isHidden) {
                     return `<span class="visible-cell-content">${cellContent}</span>`;
                 }

                 return `
                    <div onclick="toggleCellVisibility(event)">
                        <span class="hidden-cell-content">${cellContent}</span>
                        <span class="reveal-cell-placeholder">[Click to Reveal]</span>
                    </div>
                 `;
             };

            const kanjiRows = kanjiList.map((k, index) => {
                const baseClass = "px-3 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-gray-800 dark:text-gray-200";

                return `
                    <tr class="group border-b border-gray-200 dark:border-gray-700 hover:bg-indigo-50 dark:hover:bg-gray-700 transition duration-150">
                        <!-- Kanji (Always Visible) -->
                        <td class="px-3 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-lg font-bold text-indigo-600 dark:text-indigo-400">${k.kanji}</td>
                        
                        <!-- Meaning -->
                        <td class="${baseClass}" data-key="meaning" onclick="${listVisibility.meaning ? '' : 'toggleCellVisibility(event)'}">
                            ${generateCellContent(k.meaning, 'meaning')}
                        </td>
                        
                        <!-- On-yomi -->
                        <td class="${baseClass} font-mono text-red-600 dark:text-red-400" data-key="onyomi" onclick="${listVisibility.onyomi ? '' : 'toggleCellVisibility(event)'}">
                            ${generateCellContent(k.onyomi, 'onyomi')}
                        </td>
                        
                        <!-- Kun-yomi -->
                        <td class="${baseClass} font-mono text-blue-600 dark:text-blue-400" data-key="kunyomi" onclick="${listVisibility.kunyomi ? '' : 'toggleCellVisibility(event)'}">
                            ${generateCellContent(k.kunyomi, 'kunyomi')}
                        </td>
                        
                        <!-- Usage (Always Visible) -->
                        <td class="px-3 py-3 sm:px-6 sm:py-4 text-sm text-gray-600 dark:text-gray-400">
                             ${generateCellContent(k.usage, 'usage')}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Function to generate a clickable header
            const generateHeader = (title, key) => `
                <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    <div class="flex items-center justify-between">
                        <span>${title}</span>
                        ${key ? `<button onclick="toggleListColumn('${key}')" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition duration-150" title="${listVisibility[key] ? 'Hide' : 'Show'} ${title}">
                            ${getVisibilityIcon(key)}
                        </button>` : ''}
                    </div>
                </th>
            `;

            const listHtml = `
                <div class="w-full bg-white dark:bg-gray-800 rounded-xl shadow-lg p-3 sm:p-6">
                    <h2 class="text-xl sm:text-3xl font-extrabold text-gray-900 dark:text-white mb-4 text-center">${lessonTitle}</h2>
                    <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    ${generateHeader('Kanji', null)}
                                    ${generateHeader('Meaning', 'meaning')}
                                    ${generateHeader('On-yomi', 'onyomi')}
                                    ${generateHeader('Kun-yomi', 'kunyomi')}
                                    ${generateHeader('Usage', 'usage')}
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                ${kanjiRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            mainContent.innerHTML = listHtml;
        }

        window.toggleMeaningVisibility = function() {
             isMeaningHidden = !isMeaningHidden;
             isCardFlipped = false; // Always flip back to front when toggling visibility
             renderApp();
        }

        function renderFlashcard(kanjiData) {
            const lesson = KANJI_LESSONS.find(l => l.kanji.some(k => k.kanji === kanjiData.kanji));
            const lessonTitle = selectedLessons.includes('bookmarks') ? 'Bookmarked Cards' : (lesson ? `Lesson ${lesson.lesson}: ${lesson.title}` : 'Mixed Kanji');
            
            const usageItems = kanjiData.usage.map(u => `<li class="text-base sm:text-lg font-medium text-gray-800 dark:text-gray-100">${u}</li>`).join('');
            const isBookmarked = bookmarkedKanji.includes(kanjiData.kanji);
            
            const frontCardMeaningDisplay = isMeaningHidden ? '— Meaning Hidden —' : kanjiData.meaning;
            const cardCountDisplay = `${currentKanjiIndex + 1} / ${studyKanjiList.length}`;


            // Flashcard controls (Bookmark and Meaning Toggle)
            const flashcardControls = `
                <div class="flex justify-between w-full max-w-sm mx-auto mb-4">
                    <button onclick="toggleMeaningVisibility()" class="py-2 px-3 text-xs font-semibold rounded-lg transition duration-150 ${isMeaningHidden ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white'} shadow-md">
                        ${isMeaningHidden ? 'Show Meaning' : 'Hide Meaning'}
                    </button>
                    
                    <button onclick="toggleBookmark('${kanjiData.kanji}')" class="p-2 rounded-full transition duration-150 ${isBookmarked ? 'bg-yellow-200 text-yellow-500 hover:bg-yellow-300 dark:bg-yellow-800 dark:text-yellow-300 dark:hover:bg-yellow-700' : 'text-gray-500 hover:bg-gray-200 dark:text-gray-400 dark:hover:bg-gray-700'}">
                        <!-- Star Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="${isBookmarked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.152A1.5 1.5 0 0113.151 2.152l3.228 6.551 7.21.654a1.5 1.5 0 01.832 2.584l-5.26 5.147 1.244 7.234a1.5 1.5 0 01-2.176 1.581L12 18.067l-6.491 3.415a1.5 1.5 0 01-2.176-1.581l1.244-7.234L.93 11.941a1.5 1.5 0 01.832-2.584l7.21-.654 3.228-6.551z" />
                        </svg>
                    </button>
                </div>
            `;


            const cardHtml = `
                ${flashcardControls} 
                <div id="flashcard" class="perspective-1000 w-full max-w-sm h-96 mx-auto cursor-pointer" onclick="handleFlip()">
                    <div id="cardInner" class="card-inner relative w-full h-full preserve-3d shadow-2xl rounded-2xl ${isCardFlipped ? 'flipped' : ''}">
                        
                        <!-- Front Side: Kanji and Meaning -->
                        <div class="absolute w-full h-full flex flex-col items-center justify-center p-6 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-2xl backface-hidden">
                            <!-- Card Count -->
                            <p class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">${cardCountDisplay}</p>
                            
                            <p class="text-7xl sm:text-9xl font-extrabold text-indigo-600 dark:text-indigo-400 mb-4">${kanjiData.kanji}</p>
                            <h2 class="text-2xl font-semibold tracking-wider text-gray-700 dark:text-gray-300">
                                ${frontCardMeaningDisplay}
                            </h2>
                            <p class="mt-8 text-sm text-gray-500 dark:text-gray-400">Tap to see details</p>
                        </div>

                        <!-- Back Side: Readings and Usage -->
                        <div class="card-back absolute w-full h-full flex flex-col items-center justify-start p-6 bg-indigo-50 dark:bg-gray-700 text-gray-900 dark:text-white rounded-2xl backface-hidden overflow-y-auto">
                            <!-- Full Lesson Title at the Top -->
                            <p class="text-xs font-semibold text-indigo-700 dark:text-indigo-400 mb-3 text-center">${lessonTitle}</p>

                            <h3 class="text-xl font-bold mb-4 text-indigo-700 dark:text-indigo-300">${kanjiData.meaning}</h3>
                            <div class="w-full space-y-3 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md">
                                <p class="text-lg font-medium">
                                    <span class="font-bold text-gray-500 dark:text-gray-400 mr-2">On-yomi:</span>
                                    <span class="text-xl text-red-600 dark:text-red-400 font-mono">${kanjiData.onyomi}</span>
                                </p>
                                <p class="text-lg font-medium">
                                    <span class="font-bold text-gray-500 dark:text-gray-400 mr-2">Kun-yomi:</span>
                                    <span class="text-xl text-blue-600 dark:text-blue-400 font-mono">${kanjiData.kunyomi}</span>
                                </p>
                            </div>
                            
                            <div class="mt-6 p-4 bg-indigo-100 dark:bg-gray-900 rounded-lg w-full">
                                <p class="text-sm font-semibold text-indigo-800 dark:text-indigo-200 mb-1">Usage (Memorization Key):</p>
                                <ul class="space-y-2 list-disc list-inside">
                                    ${usageItems}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            mainContent.innerHTML = cardHtml;
        }

        function renderQuizMode(kanjiData) {
            const lesson = KANJI_LESSONS.find(l => l.kanji.some(k => k.kanji === kanjiData.kanji));
            const lessonTitle = selectedLessons.includes('bookmarks') ? 'Bookmarked Cards' : (lesson ? `Lesson ${lesson.lesson}: ${lesson.title}` : 'Mixed Lessons');
            const cardCountDisplay = `${currentKanjiIndex + 1} / ${studyKanjiList.length}`;
            
            const timerButtonHtml = !quizFeedback ? `
                <button onclick="togglePauseResume()" class="py-2 px-3 text-xs font-semibold rounded-lg transition duration-150 
                    ${isTimerPaused ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-red-500 hover:bg-red-600 text-white'} shadow-md">
                    ${isTimerPaused ? 'Resume Timer' : 'Pause Timer'}
                </button>
            ` : '';

            let quizContentHtml;
            
            if (quizFeedback) {
                // Answer Revealed (Review Phase)
                const revealedKanji = quizFeedback.kanjiData;
                const usageItems = revealedKanji.usage.map(u => `<li class="text-base sm:text-lg font-medium text-gray-800 dark:text-gray-100">${u}</li>`).join('');

                quizContentHtml = `
                    <div class="text-center p-6 bg-green-50 dark:bg-gray-700 rounded-xl w-full">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-bold text-green-700 dark:text-green-400">Answer Revealed</h3>
                            <span id="quizTimerDisplay" class="text-2xl font-mono text-green-800 dark:text-green-300">0.0s</span>
                        </div>
                        <p class="text-7xl sm:text-9xl font-extrabold text-indigo-600 dark:text-indigo-400 mb-4">${revealedKanji.kanji}</p>
                        
                        <div class="w-full space-y-3 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md mb-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">${revealedKanji.meaning}</h2>
                            <p class="text-lg font-medium">
                                <span class="font-bold text-gray-500 dark:text-gray-400 mr-2">On-yomi:</span>
                                <span class="text-xl text-red-600 dark:text-red-400 font-mono">${revealedKanji.onyomi}</span>
                            </p>
                            <p class="text-lg font-medium">
                                <span class="font-bold text-gray-500 dark:text-gray-400 mr-2">Kun-yomi:</span>
                                <span class="text-xl text-blue-600 dark:text-blue-400 font-mono">${revealedKanji.kunyomi}</span>
                            </p>
                        </div>
                        
                        <div class="mt-6 p-4 bg-indigo-100 dark:bg-gray-900 rounded-lg w-full">
                            <p class="text-sm font-semibold text-indigo-800 dark:text-indigo-200 mb-1">Usage:</p>
                            <ul class="space-y-2 list-disc list-inside text-left">
                                ${usageItems}
                            </ul>
                        </div>
                    </div>
                `;
            } else {
                // Recall State (Reveal Phase)
                quizContentHtml = `
                    <div class="text-center p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold text-gray-800 dark:text-white">Recall Phase</h3>
                            <span id="quizTimerDisplay" class="text-3xl font-mono text-indigo-600 dark:text-indigo-400">0.0s</span>
                        </div>
                        
                        <div class="text-center p-4 bg-indigo-50 dark:bg-gray-700 rounded-lg">
                            <p class="text-7xl sm:text-9xl font-extrabold text-indigo-600 dark:text-indigo-400">${kanjiData.kanji}</p>
                        </div>
                        <p class="mt-6 text-lg text-gray-700 dark:text-gray-300">What is the meaning and how is it read?</p>
                    </div>
                `;
            }

            const quizHtml = `
                <div class="max-w-md w-full p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg relative">
                    <!-- PROGRESS AND TITLE ARE ALWAYS VISIBLE ON QUIZ CARD FRONT/TOP -->
                    <div class="flex justify-between items-center mb-3">
                         <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400">${lessonTitle}</h3>
                         <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400">${cardCountDisplay}</h3>
                    </div>
                    
                    ${quizContentHtml}
                </div>
            `;
            
            // Add pause/resume button right under the quiz content (if applicable)
            if (!quizFeedback) {
                 mainContent.innerHTML = `
                    ${quizHtml}
                    <div class="mt-6">
                        ${timerButtonHtml}
                    </div>
                 `;
            } else {
                 mainContent.innerHTML = quizHtml;
            }
            
        }


        // --- Event Handlers (Navigation & Control) ---
        
        function handleModeSelect(mode) {
            currentMode = mode;
            // Reset selectedLessons to ALL (or just 1 for list)
            selectedLessons = KANJI_LESSONS.map(l => l.lesson);
            
            if (currentMode === 'list') {
                selectedLessons = [KANJI_LESSONS[0].lesson];
            } else if (currentMode === 'flashcard') {
                 // Check if the user has bookmarks and default to bookmark study if they do, otherwise select all lessons.
                 if (bookmarkedKanji.length > 0) {
                     selectedLessons = ['bookmarks'];
                 } else {
                     selectedLessons = KANJI_LESSONS.map(l => l.lesson);
                 }
            }
            
            currentView = 'lesson-select';
            isMeaningHidden = false; // Reset flashcard state
            renderApp();
        }


        function handleLessonSelectConfirm() {
            const checkboxes = document.querySelectorAll('.lesson-checkbox');
            
            const newlySelectedLessons = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => {
                    const lesson = cb.dataset.lesson;
                    return lesson === 'bookmarks' ? lesson : parseInt(lesson); // Keep 'bookmarks' as string
                });
            
            if (newlySelectedLessons.length === 0) {
                 showToast('You must select at least one lesson to start the study session.', 'bg-red-600');
                 return;
            }
            
            // Handle mutual exclusion/prioritization for bookmarks
            const studyingBookmarks = newlySelectedLessons.includes('bookmarks');
            if (studyingBookmarks) {
                selectedLessons = ['bookmarks'];
            }
            // For List, ensure only one lesson is selected
            if (currentMode === 'list') {
                // List mode cannot use 'bookmarks', force back to Lesson 1 if bookmarks was selected
                if (selectedLessons.includes('bookmarks')) {
                     selectedLessons = [KANJI_LESSONS[0].lesson];
                }
                if (selectedLessons.length > 1) {
                    const firstNumeric = newlySelectedLessons.find(l => typeof l === 'number');
                    selectedLessons = [firstNumeric || KANJI_LESSONS[0].lesson];
                } else {
                    selectedLessons = newlySelectedLessons.filter(l => typeof l === 'number');
                }
            }

            // Ensure selection only contains numeric lessons if not studying bookmarks
            if (!studyingBookmarks && currentMode !== 'list') {
                 selectedLessons = newlySelectedLessons.filter(l => typeof l === 'number');
            }


            compileStudyList();
            
            if (studyKanjiList.length === 0) {
                 showToast('Selected lessons contain no kanji. Please check your selection.', 'bg-red-600');
                 return;
            }

            currentKanjiIndex = 0;
            quizFeedback = null; 
            currentView = 'study';
            
            // Reset pause state when starting a new quiz
            isTimerPaused = false; 
            pauseTime = 0; 
            
            renderApp();
        }

        function handleRevealAnswer() {
            stopQuizTimers();
            
            quizFeedback = {
                isRevealed: true,
                kanjiData: studyKanjiList[currentKanjiIndex],
            };
            
            // Re-render, which triggers startReviewTimer
            renderApp(); 
        }


        function handleNext() {
            isCardFlipped = false;
            quizFeedback = null; 
            stopQuizTimers(); 
            
            if (currentMode === 'list') {
                // List Mode: Cycles the selected LESSON
                const totalLessons = KANJI_LESSONS.length;
                const currentLessonNumber = selectedLessons[0];
                const currentLessonIndex = KANJI_LESSONS.findIndex(l => l.lesson === currentLessonNumber);
                
                const nextIndex = (currentLessonIndex + 1) % totalLessons;
                
                selectedLessons = [KANJI_LESSONS[nextIndex].lesson];
                compileStudyList();
            } else if (currentMode === 'flashcard') {
                // Flashcard Mode: Cycles the CARD within the study list
                if (currentKanjiIndex < studyKanjiList.length - 1) {
                    currentKanjiIndex++;
                } else {
                    currentKanjiIndex = 0; 
                    showToast(`Session complete! Restarting and reshuffling the ${studyKanjiList.length} cards.`, 'bg-indigo-600');
                    compileStudyList(); // Re-shuffle the cards
                }
            } else { // Quiz mode 
                 if (currentKanjiIndex < studyKanjiList.length - 1) {
                    currentKanjiIndex++;
                 } else {
                    // Quiz Finished
                    showToast(`Quiz finished! You completed ${studyKanjiList.length} kanji. Returning to setup.`, 'bg-green-600');
                    currentView = 'lesson-select'; // Go back to lesson selection
                 }
            }
            
            // Reset pause state for the next card
            isTimerPaused = false;
            pauseTime = 0;

            renderApp();
        }

        function handlePrev() {
            isCardFlipped = false;
            quizFeedback = null;
            stopQuizTimers(); 
            
            const totalLessons = KANJI_LESSONS.length;

            if (currentMode === 'list') {
                // List Mode: Cycles the selected LESSON
                const currentLessonNumber = selectedLessons[0];
                const currentLessonIndex = KANJI_LESSONS.findIndex(l => l.lesson === currentLessonNumber);
                
                const prevIndex = (currentLessonIndex - 1 + totalLessons) % totalLessons;
                
                selectedLessons = [KANJI_LESSONS[prevIndex].lesson];
                compileStudyList();
            } else if (currentMode === 'flashcard') {
                // Flashcard Mode: Cycles the CARD within the study list
                if (currentKanjiIndex > 0) {
                    currentKanjiIndex--;
                } else {
                    currentKanjiIndex = studyKanjiList.length - 1; // Wrap around to the end
                }
            } else {
                // Quiz Mode: Back button goes to lesson select
                currentView = 'lesson-select'; 
            }

            renderApp();
        }
        
        function handleFlip() {
            if (currentMode === 'flashcard') {
                isCardFlipped = !isCardFlipped;
                renderApp();
            }
        }
        
        // --- Settings Modal Functions ---

        function renderSettingsModal() {
            revealDelayInput.value = userSettings.revealDelay;
            reviewDelayInput.value = userSettings.reviewDelay;
            settingsModal.style.display = 'flex';
        }

        function handleSaveSettings() {
            const newRevealDelay = parseInt(revealDelayInput.value);
            const newReviewDelay = parseInt(reviewDelayInput.value);
            
            if (isNaN(newRevealDelay) || newRevealDelay < 1 || isNaN(newReviewDelay) || newReviewDelay < 1) {
                 showToast('Both delay times must be positive whole numbers.', 'bg-red-600');
                return;
            }

            userSettings.revealDelay = newRevealDelay;
            userSettings.reviewDelay = newReviewDelay;
            settingsModal.style.display = 'none';
            renderApp();
        }

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            }
            
            loadBookmarks(); // LOAD BOOKMARKS FIRST

            // Initial setup for default selection (Lesson 1)
            selectedLessons = [1];
            compileStudyList();

            // Attach static event listeners
            darkModeToggle.addEventListener('click', toggleDarkMode);
            homeButton.addEventListener('click', handleGoToMain); 
            
            // Settings modal events
            closeSettingsModalButton.addEventListener('click', () => settingsModal.style.display = 'none');
            saveSettingsButton.addEventListener('click', handleSaveSettings);

            // Main navigation
            document.getElementById('nextButton').addEventListener('click', handleNext);
            document.getElementById('prevButton').addEventListener('click', handlePrev);
            
            // Initial Render
            renderApp();
        });
    </script>
</body>
</html>
