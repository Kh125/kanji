<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N5 Kanji Master</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for 3D flip effect and dark mode transition */
        :root {
            --flip-duration: 700ms;
        }

        /* Essential 3D properties */
        .perspective-1000 {
            perspective: 1000px;
        }
        .preserve-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        /* Card container transition */
        .card-inner {
            transition: transform var(--flip-duration);
        }

        /* Card flipped state */
        .flipped {
            transform: rotateY(180deg);
        }
        
        /* Backside rotation */
        .card-back {
            transform: rotateY(180deg);
        }

        /* Dark Mode configuration for smooth transition */
        .dark .bg-gray-900, .dark .text-white {
             transition: background-color 300ms, color 300ms;
        }
        
        /* Utility for disabling pointer events on disabled buttons in quiz */
        .quiz-disabled {
            pointer-events: none;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="transition-colors duration-300">

    <div id="app-container" class="min-h-screen font-sans">
        <!-- Header -->
        <header class="py-6 shadow-md bg-white dark:bg-gray-800">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-2xl font-extrabold text-indigo-600 dark:text-indigo-400 tracking-tight">
                    N5 Kanji Master
                </h1>
                <div class="items-center space-x-4 flex">
                    <!-- Home Button (New Global Navigation) -->
                    <button id="homeButton" class="p-2 rounded-full transition duration-300 hover:bg-gray-200 dark:hover:bg-gray-700" aria-label="Go to Main Menu" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500 dark:text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                    </button>
                    <!-- Dark Mode Toggle -->
                    <button id="darkModeToggle" class="p-2 rounded-full transition duration-300 hover:bg-gray-200 dark:hover:bg-gray-700" aria-label="Toggle Dark Mode">
                        <!-- SVG will be updated by JS -->
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
            
            <!-- Progress Bar and Indicator -->
            <div class="mb-8 flex justify-between items-center text-gray-700 dark:text-gray-300">
                <p id="modeIndicator" class="text-lg font-bold">Welcome</p>
                <p id="progressIndicator" class="text-xl font-mono">N5 (103)</p>
            </div>
            
            <!-- Dynamic Controls (Start Study/Settings/Back button) -->
            <div id="modeControls" class="flex justify-center space-x-4 mb-6">
                <!-- Content injected here by JavaScript -->
            </div>

            <!-- Main Content Area -->
            <div id="mainContent" class="flex flex-col items-center">
                <!-- Content injected here by JavaScript -->
            </div>

            <!-- Navigation Buttons (Used primarily in Study View) -->
            <div id="navButtons" class="flex space-x-4 mt-10 w-full max-w-sm mx-auto" style="display: none;">
                <button id="prevButton" class="flex-1 flex items-center justify-center py-3 px-6 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white font-bold rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-150 shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Previous
                </button>
                <button id="nextButton" class="flex-1 flex items-center justify-center py-3 px-6 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg">
                    Next
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                    </svg>
                </button>
            </div>

            <p id="hintText" class="mt-6 text-sm italic text-gray-500 dark:text-gray-400 text-center"></p>

        </main>
    </div>
    
    <!-- Settings Modal Overlay -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300" style="display: none;">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Quiz Settings</h2>
            <div class="space-y-6">
                <div>
                    <label for="revealDelay" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Kanji Reveal Delay (Seconds)
                    </label>
                    <input type="number" id="revealDelay" min="1" max="60" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Time the Kanji symbol is shown before the answer is revealed.</p>
                </div>
                <div>
                    <label for="reviewDelay" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Review Time (Seconds)
                    </label>
                    <input type="number" id="reviewDelay" min="1" max="60" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Time the full answer is shown before automatically advancing.</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="closeSettingsModalButton" class="py-2 px-4 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
                <button id="saveSettingsButton" class="py-2 px-4 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        // --- N5 Kanji Data structured into Lessons (103 Kanji Total) ---
        const KANJI_LESSONS = [
            {
                lesson: 1,
                title: "Numbers & Basic Concepts",
                kanji: [
                    { kanji: 'ä¸€', meaning: 'One', onyomi: 'ã‚¤ãƒ', kunyomi: 'ã²ã¨(ã¤)', usage: ['ä¸€ã¤ (ã²ã¨(ã¤))', 'ä¸€ç•ª (ã„ã¡ã°ã‚“)'] },
                    { kanji: 'äºŒ', meaning: 'Two', onyomi: 'ãƒ‹', kunyomi: 'ãµãŸ(ã¤)', usage: ['äºŒã¤ (ãµãŸ(ã¤))', 'äºŒéšŽ (ã«ã‹ã„)'] },
                    { kanji: 'ä¸‰', meaning: 'Three', onyomi: 'ã‚µãƒ³', kunyomi: 'ã¿(ã¤)', usage: ['ä¸‰æ—¥ (ã¿(ã£ã‹))'] },
                    { kanji: 'å››', meaning: 'Four', onyomi: 'ã‚·', kunyomi: 'ã‚ˆ(ã‚“)', usage: ['å››æ™‚ (ã‚ˆ(ã˜))', 'å››ã¤ (ã‚ˆã£ã¤)'] },
                    { kanji: 'äº”', meaning: 'Five', onyomi: 'ã‚´', kunyomi: 'ã„ã¤(ã¤)', usage: ['äº”äºº (ã”(ã«ã‚“))'] },
                    { kanji: 'å…­', meaning: 'Six', onyomi: 'ãƒ­ã‚¯', kunyomi: 'ã‚€ã£(ã¤)', usage: ['å…­ã¤ (ã‚€(ã£ã¤))'] },
                    { kanji: 'ä¸ƒ', meaning: 'Seven', onyomi: 'ã‚·ãƒ', kunyomi: 'ãªãª(ã¤)', usage: ['ä¸ƒã¤ (ãªãª(ã¤))', 'ä¸ƒæœˆ (ã—ã¡ãŒã¤)'] },
                    { kanji: 'å…«', meaning: 'Eight', onyomi: 'ãƒãƒ', kunyomi: 'ã‚„(ã¤)', usage: ['å…«ç™¾ (ã¯(ã£ã´ã‚ƒã))'] },
                    { kanji: 'ä¹', meaning: 'Nine', onyomi: 'ã‚­ãƒ¥ã‚¦, ã‚¯', kunyomi: 'ã“ã“ã®(ã¤)', usage: ['ä¹æ™‚ (ã(ã˜))', 'ä¹æœˆ (ããŒã¤)'] },
                    { kanji: 'å', meaning: 'Ten', onyomi: 'ã‚¸ãƒ¥ã‚¦', kunyomi: 'ã¨ãŠ', usage: ['åæ—¥ (ã¨ãŠ(ã‹))', 'åå­—è·¯ (ã˜ã‚…ã†ã˜ã‚)'] },
                    { kanji: 'ç™¾', meaning: 'Hundred', onyomi: 'ãƒ’ãƒ£ã‚¯', kunyomi: 'ã‚‚ã‚‚', usage: ['ä¸‰ç™¾ (ã‚µãƒ³ãƒ“ãƒ£ã‚¯)'] },
                    { kanji: 'åƒ', meaning: 'Thousand', onyomi: 'ã‚»ãƒ³', kunyomi: 'ã¡', usage: ['ä¸‰åƒ (ã‚µãƒ³ã‚¼ãƒ³)'] },
                ]
            },
            {
                lesson: 2,
                title: "Large Numbers, Time & Money",
                kanji: [
                    { kanji: 'ä¸‡', meaning: 'Ten Thousand', onyomi: 'ãƒžãƒ³', kunyomi: 'ã‚ˆã‚ãš', usage: ['ä¸€ä¸‡å†† (ã„ã¡(ã¾ã‚“ãˆã‚“))'] },
                    { kanji: 'å††', meaning: 'Yen, Circle', onyomi: 'ã‚¨ãƒ³', kunyomi: 'ã¾ã‚‹(ã„)', usage: ['ç™¾å†† (ã²ã‚ƒã(ãˆã‚“))'] },
                    { kanji: 'æ™‚', meaning: 'Time, Hour', onyomi: 'ã‚¸', kunyomi: 'ã¨ã', usage: ['æ™‚é–“ (ã˜(ã‹ã‚“))', 'æ™‚è¨ˆ (ã¨ã‘ã„)'] },
                    { kanji: 'å¹´', meaning: 'Year', onyomi: 'ãƒãƒ³', kunyomi: 'ã¨ã—', usage: ['åŽ»å¹´ (ãã‚‡(ã­ã‚“))', 'ä»Šå¹´ (ã“ã¨ã—)'] },
                    { kanji: 'åˆ†', meaning: 'Minute, Part', onyomi: 'ãƒ–ãƒ³, ãƒ•ãƒ³', kunyomi: 'ã‚(ã‘ã‚‹)', usage: ['äº”åˆ† (ã”(ãµã‚“))', 'åˆ†ã‹ã‚‹ (ã‚(ã‹ã‚‹))'] },
                    { kanji: 'å‰', meaning: 'Before, Front', onyomi: 'ã‚¼ãƒ³', kunyomi: 'ã¾ãˆ', usage: ['åˆå‰ (ã”(ãœã‚“))', 'å‰ (ã¾ãˆ)'] },
                    { kanji: 'å¾Œ', meaning: 'After, Back', onyomi: 'ã‚´, ã‚³ã‚¦', kunyomi: 'ã†ã—(ã‚)', usage: ['åˆå¾Œ (ã”(ã”))', 'å¾Œã§ (ã‚ã¨ã§)'] },
                    { kanji: 'ä»Š', meaning: 'Now', onyomi: 'ã‚³ãƒ³', kunyomi: 'ã„ã¾', usage: ['ä»Šæ—¥ (ãã‚‡(ã†))', 'ä»Šé€± (ã“ã‚“ã—ã‚…ã†)'] },
                    { kanji: 'åŠ', meaning: 'Half', onyomi: 'ãƒãƒ³', kunyomi: 'ãªã‹(ã°)', usage: ['ä¸‰æ™‚åŠ (ã•ã‚“(ã˜ã¯ã‚“))'] },
                    { kanji: 'æ¯Ž', meaning: 'Every', onyomi: 'ãƒžã‚¤', kunyomi: 'ã”ã¨', usage: ['æ¯Žæ—¥ (ã¾ã„(ã«ã¡))', 'æ¯Žæœ (ã¾ã„ã‚ã•)'] },
                    { kanji: 'ä½•', meaning: 'What, How', onyomi: 'ã‚«', kunyomi: 'ãªã«, ãªã‚“', usage: ['ä½•æ™‚ (ãªã‚“(ã˜))', 'ä½• (ãªã«)'] },
                    { kanji: 'åˆ', meaning: 'Noon', onyomi: 'ã‚´', kunyomi: 'ã†ã¾', usage: ['åˆå‰ (ã”(ãœã‚“))'] },
                ]
            },
            {
                lesson: 3,
                title: "Days of the Week",
                kanji: [
                    { kanji: 'æ—¥', meaning: 'Day, Sun', onyomi: 'ãƒ‹ãƒ, ã‚¸ãƒ„', kunyomi: 'ã², ã‹', usage: ['æ—¥æ›œæ—¥ (ã«ã¡(ã‚ˆã†ã³))', 'æ—¥æœ¬ (ã«ã»ã‚“)'] },
                    { kanji: 'æœˆ', meaning: 'Month, Moon', onyomi: 'ã‚²ãƒ„, ã‚¬ãƒ„', kunyomi: 'ã¤ã', usage: ['æœˆæ›œæ—¥ (ã’ã¤(ã‚ˆã†ã³))', 'ä»Šæœˆ (ã“ã‚“ã’ã¤)'] },
                    { kanji: 'ç«', meaning: 'Fire', onyomi: 'ã‚«', kunyomi: 'ã²', usage: ['ç«æ›œæ—¥ (ã‹(ã‚ˆã†ã³))'] },
                    { kanji: 'æ°´', meaning: 'Water', onyomi: 'ã‚¹ã‚¤', kunyomi: 'ã¿ãš', usage: ['æ°´æ›œæ—¥ (ã™ã„(ã‚ˆã†ã³))', 'æ°´é“ (ã™ã„ã©ã†)'] },
                    { kanji: 'æœ¨', meaning: 'Tree, Wood', onyomi: 'ãƒœã‚¯, ãƒ¢ã‚¯', kunyomi: 'ã', usage: ['æœ¨æ›œæ—¥ (ã‚‚ã(ã‚ˆã†ã³))'] },
                    { kanji: 'é‡‘', meaning: 'Gold, Money', onyomi: 'ã‚­ãƒ³', kunyomi: 'ã‹ã­', usage: ['é‡‘æ›œæ—¥ (ãã‚“(ã‚ˆã†ã³))', 'ãŠé‡‘ (ãŠã‹ã­)'] },
                    { kanji: 'åœŸ', meaning: 'Earth, Soil', onyomi: 'ãƒ‰, ãƒˆ', kunyomi: 'ã¤ã¡', usage: ['åœŸæ›œæ—¥ (ã©(ã‚ˆã†ã³))', 'åœŸåœ° (ã¨ã¡)'] },
                    { kanji: 'æ›œ', meaning: 'Weekday', onyomi: 'ãƒ¨ã‚¦', kunyomi: '', usage: ['æ—¥æ›œæ—¥ (ã«ã¡(ã‚ˆã†ã³))'] },
                    { kanji: 'é€±', meaning: 'Week', onyomi: 'ã‚·ãƒ¥ã‚¦', kunyomi: '', usage: ['ä»Šé€± (ã“ã‚“(ã—ã‚…ã†))'] },
                    { kanji: 'å…ˆ', meaning: 'Previous, Ahead', onyomi: 'ã‚»ãƒ³', kunyomi: 'ã•ã', usage: ['å…ˆé€± (ã›ã‚“(ã—ã‚…ã†))', 'å…ˆç”Ÿ (ã›ã‚“ã›ã„)'] },
                    { kanji: 'æ¥', meaning: 'Come, Next', onyomi: 'ãƒ©ã‚¤', kunyomi: 'ã(ã‚‹)', usage: ['æ¥é€± (ã‚‰ã„(ã—ã‚…ã†))', 'æ¥ã‚‹ (ã(ã‚‹))'] },
                ]
            },
            {
                lesson: 4,
                title: "Location and Direction",
                kanji: [
                    { kanji: 'ä¸Š', meaning: 'Up, Above', onyomi: 'ã‚¸ãƒ§ã‚¦', kunyomi: 'ã†ãˆ, ã‚(ãŒã‚‹)', usage: ['ä¸Šç€ (ã†ã‚(ãŽ))', 'ä¸Šã’ã‚‹ (ã‚(ã’ã‚‹))'] },
                    { kanji: 'ä¸‹', meaning: 'Down, Below', onyomi: 'ã‚«, ã‚²', kunyomi: 'ããŸ, ã•(ãŒã‚‹)', usage: ['åœ°ä¸‹ (ã¡(ã‹))', 'ä¸‹ã•ã„ (ãã (ã•ã„))'] },
                    { kanji: 'ä¸­', meaning: 'Middle, Inside', onyomi: 'ãƒãƒ¥ã‚¦', kunyomi: 'ãªã‹', usage: ['ä¸­å›½ (ã¡ã‚…ã†(ã”ã))', 'ä¸­ (ãªã‹)'] },
                    { kanji: 'å¤–', meaning: 'Outside', onyomi: 'ã‚¬ã‚¤', kunyomi: 'ãã¨', usage: ['å¤–å›½ (ãŒã„(ã“ã))', 'å¤– (ãã¨)'] },
                    { kanji: 'å³', meaning: 'Right', onyomi: 'ã‚¦, ãƒ¦ã‚¦', kunyomi: 'ã¿ãŽ', usage: ['å³å´ (ã¿ãŽ(ãŒã‚))'] },
                    { kanji: 'å·¦', meaning: 'Left', onyomi: 'ã‚µ', kunyomi: 'ã²ã ã‚Š', usage: ['å·¦å´ (ã²ã ã‚Š(ãŒã‚))'] },
                    { kanji: 'åŒ—', meaning: 'North', onyomi: 'ãƒ›ã‚¯', kunyomi: 'ããŸ', usage: ['åŒ—å£ (ããŸ(ãã¡))'] },
                    { kanji: 'å—', meaning: 'South', onyomi: 'ãƒŠãƒ³', kunyomi: 'ã¿ãªã¿', usage: ['å—å£ (ã¿ãªã¿(ãã¡))'] },
                    { kanji: 'æ±', meaning: 'East', onyomi: 'ãƒˆã‚¦', kunyomi: 'ã²ãŒã—', usage: ['æ±å£ (ã²ãŒã—(ãã¡))'] },
                    { kanji: 'è¥¿', meaning: 'West', onyomi: 'ã‚»ã‚¤, ã‚¶ã‚¤', kunyomi: 'ã«ã—', usage: ['è¥¿å£ (ã«ã—(ãã¡))'] },
                    { kanji: 'å£', meaning: 'Mouth, Entrance', onyomi: 'ã‚³ã‚¦', kunyomi: 'ãã¡', usage: ['å…¥å£ (ã„ã‚Š(ãã¡))', 'å‡ºå£ (ã§ãã¡)'] },
                ]
            },
            {
                lesson: 5,
                title: "People and Family",
                kanji: [
                    { kanji: 'äºº', meaning: 'Person', onyomi: 'ã‚¸ãƒ³, ãƒ‹ãƒ³', kunyomi: 'ã²ã¨', usage: ['æ—¥æœ¬äºº (ã«ã»ã‚“(ã˜ã‚“))', 'ä¸€äºº (ã²ã¨ã‚Š)'] },
                    { kanji: 'å', meaning: 'Name', onyomi: 'ãƒ¡ã‚¤, ãƒŸãƒ§ã‚¦', kunyomi: 'ãª', usage: ['åå‰ (ãª(ã¾ãˆ))', 'æœ‰å (ã‚†ã†ã‚ã„)'] },
                    { kanji: 'æœ¬', meaning: 'Book, Origin', onyomi: 'ãƒ›ãƒ³', kunyomi: 'ã‚‚ã¨', usage: ['æ—¥æœ¬ (ã«(ã»ã‚“))', 'æœ¬ (ã»ã‚“)'] },
                    { kanji: 'å…ˆ', meaning: 'Previous, Ahead', onyomi: 'ã‚»ãƒ³', kunyomi: 'ã•ã', usage: ['å…ˆç”Ÿ (ã›ã‚“(ã›ã„))', 'å…ˆé€± (ã›ã‚“ã—ã‚…ã†)'] },
                    { kanji: 'ç”Ÿ', meaning: 'Life, Birth', onyomi: 'ã‚»ã‚¤, ã‚·ãƒ§ã‚¦', kunyomi: 'ã„(ãã‚‹)', usage: ['å­¦ç”Ÿ (ãŒã(ã›ã„))', 'ç”Ÿã¾ã‚Œã‚‹ (ã†(ã¾ã‚Œã‚‹))'] },
                    { kanji: 'å­¦', meaning: 'Study, Learn', onyomi: 'ã‚¬ã‚¯', kunyomi: 'ã¾ãª(ã¶)', usage: ['å¤§å­¦ (ã ã„(ãŒã))', 'å­¦æ ¡ (ãŒã£ã“ã†)'] },
                    { kanji: 'å‹', meaning: 'Friend', onyomi: 'ãƒ¦ã‚¦', kunyomi: 'ã¨ã‚‚', usage: ['å‹é” (ã¨ã‚‚(ã ã¡))'] },
                    { kanji: 'çˆ¶', meaning: 'Father', onyomi: 'ãƒ•', kunyomi: 'ã¡ã¡', usage: ['ãŠçˆ¶ã•ã‚“ (ãŠ(ã¨ã†ã•ã‚“))'] },
                    { kanji: 'æ¯', meaning: 'Mother', onyomi: 'ãƒœ', kunyomi: 'ã¯ã¯', usage: ['ãŠæ¯ã•ã‚“ (ãŠ(ã‹ã‚ã•ã‚“))'] },
                    { kanji: 'å­', meaning: 'Child', onyomi: 'ã‚·, ã‚¹', kunyomi: 'ã“', usage: ['å­ä¾› (ã“(ã©ã‚‚))', 'å¥³å­ (ã˜ã‚‡ã—)'] },
                    { kanji: 'å¥³', meaning: 'Woman, Female', onyomi: 'ã‚¸ãƒ§', kunyomi: 'ãŠã‚“ãª', usage: ['å¥³ã®å­ (ãŠã‚“ãª(ã®ã“))', 'å¥³æ€§ (ã˜ã‚‡ã›ã„)'] },
                ]
            },
            {
                lesson: 6,
                title: "Actions and Movement",
                kanji: [
                    { kanji: 'ç”·', meaning: 'Man, Male', onyomi: 'ãƒ€ãƒ³, ãƒŠãƒ³', kunyomi: 'ãŠã¨ã“', usage: ['ç”·ã®äºº (ãŠã¨ã“(ã®ã²ã¨))', 'ç”·å­ (ã ã‚“ã—)'] },
                    { kanji: 'å±±', meaning: 'Mountain', onyomi: 'ã‚µãƒ³', kunyomi: 'ã‚„ã¾', usage: ['å¯Œå£«å±± (ãµã˜(ã•ã‚“))'] },
                    { kanji: 'å·', meaning: 'River', onyomi: 'ã‚»ãƒ³', kunyomi: 'ã‹ã‚', usage: ['å·ä¸Š (ã‹ã‚(ã‹ã¿))', 'ãƒŠã‚¤ãƒ«å· (ãƒŠã‚¤ãƒ«ãŒã‚)'] },
                    { kanji: 'ç”°', meaning: 'Rice Paddy', onyomi: 'ãƒ‡ãƒ³', kunyomi: 'ãŸ', usage: ['ç”°ä¸­ (ãŸ(ãªã‹))'] },
                    { kanji: 'é£Ÿ', meaning: 'Eat, Food', onyomi: 'ã‚·ãƒ§ã‚¯', kunyomi: 'ãŸ(ã¹ã‚‹)', usage: ['é£Ÿã¹ç‰© (ãŸ(ã¹ã‚‚ã®))', 'é£Ÿäº‹ (ã—ã‚‡ãã˜)'] },
                    { kanji: 'é£²', meaning: 'Drink', onyomi: 'ã‚¤ãƒ³', kunyomi: 'ã®(ã‚€)', usage: ['é£²ã¿ç‰© (ã®(ã¿ã‚‚ã®))', 'é£²ã‚€ (ã®(ã‚€))'] },
                    { kanji: 'è¦‹', meaning: 'See, Look', onyomi: 'ã‚±ãƒ³', kunyomi: 'ã¿(ã‚‹)', usage: ['è¦‹ã‚‹ (ã¿(ã‚‹))', 'è¦‹ã›ã‚‹ (ã¿(ã›ã‚‹))'] },
                    { kanji: 'èž', meaning: 'Hear, Ask', onyomi: 'ãƒ–ãƒ³', kunyomi: 'ã(ã)', usage: ['èžã (ã(ã))', 'æ–°èž (ã—ã‚“ã¶ã‚“)'] },
                    { kanji: 'è¨€', meaning: 'Say, Word', onyomi: 'ã‚²ãƒ³', kunyomi: 'ã„(ã†)', usage: ['è¨€ã† (ã„(ã†))', 'è¨€èªž (ã’ã‚“ã”)'] },
                    { kanji: 'è©±', meaning: 'Talk, Story', onyomi: 'ãƒ¯', kunyomi: 'ã¯ãª(ã™)', usage: ['è©±ã™ (ã¯ãª(ã™))', 'ä¼šè©± (ã‹ã„ã‚)'] },
                    { kanji: 'ç«‹', meaning: 'Stand', onyomi: 'ãƒªãƒ„', kunyomi: 'ãŸ(ã¤)', usage: ['ç«‹ã¤ (ãŸ(ã¤))', 'å›½ç«‹ (ã“ãã‚Šã¤)'] },
                    { kanji: 'æ›¸', meaning: 'Write', onyomi: 'ã‚·ãƒ§', kunyomi: 'ã‹(ã)', usage: ['æ‰‹ç´™ã‚’æ›¸ã (ã¦(ãŒã¿ã‚’ã‹)ã)', 'è¾žæ›¸ (ã˜ã—ã‚‡)'] },
                ]
            },
            {
                lesson: 7,
                title: "Home and Place",
                kanji: [
                    { kanji: 'èªž', meaning: 'Language, Word', onyomi: 'ã‚´', kunyomi: 'ã‹ãŸ(ã‚‹)', usage: ['è‹±èªž (ãˆã„(ã”))', 'æ—¥æœ¬èªž (ã«ã»ã‚“ã”)'] },
                    { kanji: 'è²·', meaning: 'Buy', onyomi: 'ãƒã‚¤', kunyomi: 'ã‹(ã†)', usage: ['è²·ã„ç‰© (ã‹(ã„ã‚‚ã®))', 'è²·ã† (ã‹(ã†))'] },
                    { kanji: 'èª­', meaning: 'Read', onyomi: 'ãƒ‰ã‚¯', kunyomi: 'ã‚ˆ(ã‚€)', usage: ['èª­ã‚€ (ã‚ˆ(ã‚€))', 'èª­æ›¸ (ã©ãã—ã‚‡)'] },
                    { kanji: 'ä¼‘', meaning: 'Rest, Day Off', onyomi: 'ã‚­ãƒ¥ã‚¦', kunyomi: 'ã‚„ã™(ã‚€)', usage: ['ä¼‘ã¿ (ã‚„ã™(ã¿))', 'ä¼‘æ—¥ (ãã‚…ã†ã˜ã¤)'] },
                    { kanji: 'è¡Œ', meaning: 'Go, Conduct', onyomi: 'ã‚³ã‚¦, ã‚®ãƒ§ã‚¦', kunyomi: 'ã„(ã)', usage: ['éŠ€è¡Œ (ãŽã‚“(ã“ã†))', 'è¡Œã (ã„(ã))', 'æ—…è¡Œ (ã‚Šã‚‡ã“ã†)'] },
                    { kanji: 'æ¥', meaning: 'Come, Next', onyomi: 'ãƒ©ã‚¤', kunyomi: 'ã(ã‚‹)', usage: ['æ¥ã‚‹ (ã(ã‚‹))', 'æ¥æœˆ (ã‚‰ã„ã’ã¤)'] },
                    { kanji: 'å…¥', meaning: 'Enter, Insert', onyomi: 'ãƒ‹ãƒ¥ã‚¦', kunyomi: 'ã¯ã„(ã‚‹)', usage: ['å…¥ã‚‹ (ã¯ã„(ã‚‹))', 'å…¥å­¦ (ã«ã‚…ã†ãŒã)'] },
                    { kanji: 'å‡º', meaning: 'Exit, Leave', onyomi: 'ã‚·ãƒ¥ãƒ„', kunyomi: 'ã§(ã‚‹)', usage: ['å‡ºã‹ã‘ã‚‹ (ã§(ã‹ã‘ã‚‹))', 'å‡ºã™ (ã ã™)'] },
                    { kanji: 'ä¼š', meaning: 'Meet, Association', onyomi: 'ã‚«ã‚¤, ã‚¨', kunyomi: 'ã‚(ã†)', usage: ['ä¼šç¤¾ (ã‹ã„(ã—ã‚ƒ))', 'ä¼šã† (ã‚(ã†))'] },
                    { kanji: 'ç¤¾', meaning: 'Company, Shrine', onyomi: 'ã‚·ãƒ£', kunyomi: 'ã‚„ã—ã‚', usage: ['ä¼šç¤¾ (ã‹ã„(ã—ã‚ƒ))'] },
                    { kanji: 'åº—', meaning: 'Shop, Store', onyomi: 'ãƒ†ãƒ³', kunyomi: 'ã¿ã›', usage: ['å–«èŒ¶åº— (ãã£ã•(ã¦ã‚“))', 'åº— (ã¿ã›)'] },
                    { kanji: 'é§…', meaning: 'Station', onyomi: 'ã‚¨ã‚­', kunyomi: '', usage: ['é§…å‰ (ãˆã(ã¾ãˆ))'] },
                ]
            },
            {
                lesson: 8,
                title: "Direction, Size, and Adjectives",
                kanji: [
                    { kanji: 'é“', meaning: 'Road, Way', onyomi: 'ãƒ‰ã‚¦', kunyomi: 'ã¿ã¡', usage: ['æŸ”é“ (ã˜ã‚…ã†(ã©ã†))', 'é“ (ã¿ã¡)'] },
                    { kanji: 'å›½', meaning: 'Country', onyomi: 'ã‚³ã‚¯', kunyomi: 'ãã«', usage: ['å¤–å›½ (ãŒã„(ã“ã))', 'å›½ (ãã«)'] },
                    { kanji: 'å¤§', meaning: 'Large, Big', onyomi: 'ãƒ€ã‚¤, ã‚¿ã‚¤', kunyomi: 'ãŠãŠ(ãã„)', usage: ['å¤§ãã„ (ãŠãŠ(ãã„))', 'å¤§å­¦ (ã ã„ãŒã)'] },
                    { kanji: 'å°', meaning: 'Small', onyomi: 'ã‚·ãƒ§ã‚¦', kunyomi: 'ã¡ã„(ã•ã„)', usage: ['å°ã•ã„ (ã¡ã„(ã•ã„))', 'å°å­¦æ ¡ (ã—ã‚‡ã†ãŒã£ã“ã†)'] },
                    { kanji: 'é«˜', meaning: 'High, Expensive', onyomi: 'ã‚³ã‚¦', kunyomi: 'ãŸã‹(ã„)', usage: ['é«˜ã„ (ãŸã‹(ã„))', 'é«˜æ ¡ (ã“ã†ã“ã†)'] },
                    { kanji: 'å®‰', meaning: 'Cheap, Peaceful', onyomi: 'ã‚¢ãƒ³', kunyomi: 'ã‚„ã™(ã„)', usage: ['å®‰ã„ (ã‚„ã™(ã„))', 'å®‰å¿ƒ (ã‚ã‚“ã—ã‚“)'] },
                    { kanji: 'æ–°', meaning: 'New', onyomi: 'ã‚·ãƒ³', kunyomi: 'ã‚ãŸã‚‰(ã—ã„)', usage: ['æ–°èž (ã—ã‚“(ã¶ã‚“))', 'æ–°ã—ã„ (ã‚ãŸã‚‰(ã—ã„))'] },
                    { kanji: 'å¤', meaning: 'Old', onyomi: 'ã‚³', kunyomi: 'ãµã‚‹(ã„)', usage: ['å¤ã„ (ãµã‚‹(ã„))', 'ä¸­å¤è»Š (ã¡ã‚…ã†ã“ã—ã‚ƒ)'] },
                    { kanji: 'é•·', meaning: 'Long, Leader', onyomi: 'ãƒãƒ§ã‚¦', kunyomi: 'ãªãŒ(ã„)', usage: ['é•·ã„ (ãªãŒ(ã„))', 'ç¤¾é•· (ã—ã‚ƒã¡ã‚‡ã†)'] },
                    { kanji: 'å¤š', meaning: 'Many, Much', onyomi: 'ã‚¿', kunyomi: 'ãŠãŠ(ã„)', usage: ['å¤šã„ (ãŠãŠ(ã„))'] },
                    { kanji: 'å°‘', meaning: 'Few, Little', onyomi: 'ã‚·ãƒ§ã‚¦', kunyomi: 'ã™ã“(ã—), ã™ã(ãªã„)', usage: ['å°‘ã— (ã™ã“(ã—))', 'å°‘ãªã„ (ã™ã(ãªã„))'] },
                    { kanji: 'åºƒ', meaning: 'Wide, Broad', onyomi: 'ã‚³ã‚¦', kunyomi: 'ã²ã‚(ã„)', usage: ['åºƒã„ (ã²ã‚(ã„))', 'åºƒå ´ (ã²ã‚ã°)'] },
                ]
            },
            {
                lesson: 9,
                title: "Colors and Body",
                kanji: [
                    { kanji: 'æ—©', meaning: 'Early, Fast', onyomi: 'ã‚½ã‚¦', kunyomi: 'ã¯ã‚„(ã„)', usage: ['æ—©ã„ (ã¯ã‚„(ã„))', 'æ—©æœ (ãã†ã¡ã‚‡ã†)'] },
                    { kanji: 'ç™½', meaning: 'White', onyomi: 'ãƒã‚¯', kunyomi: 'ã—ã‚(ã„)', usage: ['ç™½ã„ (ã—ã‚(ã„))'] },
                    { kanji: 'é»’', meaning: 'Black', onyomi: 'ã‚³ã‚¯', kunyomi: 'ãã‚(ã„)', usage: ['é»’ã„ (ãã‚(ã„))'] },
                    { kanji: 'èµ¤', meaning: 'Red', onyomi: 'ã‚»ã‚­', kunyomi: 'ã‚ã‹(ã„)', usage: ['èµ¤ã„ (ã‚ã‹(ã„))', 'èµ¤è‰² (ã‚ã‹ã„ã‚)'] },
                    { kanji: 'é’', meaning: 'Blue', onyomi: 'ã‚»ã‚¤', kunyomi: 'ã‚ãŠ(ã„)', usage: ['é’ã„ (ã‚ãŠ(ã„))', 'é’å¹´ (ã›ã„ã­ã‚“)'] },
                    { kanji: 'è¿‘', meaning: 'Near, Close', onyomi: 'ã‚­ãƒ³', kunyomi: 'ã¡ã‹(ã„)', usage: ['è¿‘ã„ (ã¡ã‹(ã„))', 'è¿‘æ‰€ (ãã‚“ã˜ã‚‡)'] },
                    { kanji: 'é ', meaning: 'Far', onyomi: 'ã‚¨ãƒ³', kunyomi: 'ã¨ãŠ(ã„)', usage: ['é ã„ (ã¨ãŠ(ã„))', 'é è¶³ (ãˆã‚“ãã)'] },
                    { kanji: 'ä½“', meaning: 'Body', onyomi: 'ã‚¿ã‚¤', kunyomi: 'ã‹ã‚‰ã ', usage: ['ä½“ (ã‹ã‚‰ã )', 'ä½“è‚² (ãŸã„ã„ã)'] },
                    { kanji: 'ç›®', meaning: 'Eye', onyomi: 'ãƒ¢ã‚¯', kunyomi: 'ã‚', usage: ['ç›® (ã‚)', 'ç›®çš„ (ã‚‚ãã¦ã)'] },
                    { kanji: 'è€³', meaning: 'Ear', onyomi: 'ã‚¸', kunyomi: 'ã¿ã¿', usage: ['è€³ (ã¿ã¿)', 'è€³é¼»ç§‘ (ã˜ã³ã‹)'] },
                    { kanji: 'æ‰‹', meaning: 'Hand', onyomi: 'ã‚·ãƒ¥', kunyomi: 'ã¦', usage: ['ä¸Šæ‰‹ (ã˜ã‚‡ã†(ãš))', 'æ‰‹ç´™ (ã¦ãŒã¿)'] },
                    { kanji: 'è¶³', meaning: 'Foot, Leg', onyomi: 'ã‚½ã‚¯', kunyomi: 'ã‚ã—', usage: ['è¶³ (ã‚ã—)', 'ä¸€è¶³ (ã„ã£ãã)'] },
                    { kanji: 'é›¨', meaning: 'Rain', onyomi: 'ã‚¦', kunyomi: 'ã‚ã‚', usage: ['é›¨ãŒé™ã‚‹ (ã‚ã‚(ãŒãµ)ã‚‹)'] },
                ]
            }
        ];
        
        // Flattened list of ALL kanji
        const ALL_KANJI = KANJI_LESSONS.flatMap(lesson => lesson.kanji);

        // --- State Management ---
        let currentView = 'mode-select'; // 'mode-select', 'lesson-select', or 'study'
        let currentMode = 'list'; // 'list', 'flashcard', or 'quiz'
        let currentKanjiIndex = 0;
        let isCardFlipped = false;
        let isDarkMode = true;
        let quizFeedback = null;

        // Lesson state for all modes
        let selectedLessons = [1, 2, 3, 4, 5, 6, 7, 8, 9];
        let studyKanjiList = ALL_KANJI; // This list will be filtered based on mode/selection
        
        // Quiz interval state
        let quizIntervalId = null;
        let timerDuration = 0;
        let timerStartTime = 0;
        
        // User Settings (Custom intervals)
        let userSettings = {
            revealDelay: 5, 
            reviewDelay: 4, 
        };


        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const homeButton = document.getElementById('homeButton'); // NEW HOME BUTTON
        const modeControls = document.getElementById('modeControls');
        const mainContent = document.getElementById('mainContent');
        const progressIndicator = document.getElementById('progressIndicator');
        const modeIndicator = document.getElementById('modeIndicator');
        const hintText = document.getElementById('hintText');
        const navButtons = document.getElementById('navButtons');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        
        // Settings Modal elements
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalButton = document.getElementById('closeSettingsModalButton');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const revealDelayInput = document.getElementById('revealDelay');
        const reviewDelayInput = document.getElementById('reviewDelay');


        // --- Utility Functions ---

        // Simple shuffle function
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Compiles the list of kanji for the current study session based on selectedLessons.
         */
        function compileStudyList() {
            let filteredKanji = KANJI_LESSONS
                .filter(lesson => selectedLessons.includes(lesson.lesson))
                .flatMap(lesson => lesson.kanji);
            
            if (currentMode === 'quiz') {
                studyKanjiList = shuffleArray(filteredKanji);
            } else {
                // For list/flashcard, preserve original lesson order
                studyKanjiList = filteredKanji;
            }

            currentKanjiIndex = 0;
        }

        // --- Quiz Timer/Interval Logic ---
        
        /**
         * Stops all running quiz timers/intervals.
         */
        function stopQuizTimers() {
            clearInterval(quizIntervalId);
            quizIntervalId = null;
        }

        /**
         * Starts the continuous countdown display and checks for phase completion.
         */
        function startQuizInterval(durationMs, onComplete) {
            stopQuizTimers();
            timerDuration = durationMs;
            timerStartTime = Date.now();

            const timerDisplay = document.getElementById('quizTimerDisplay');
            if (timerDisplay) {
                // Initial update
                timerDisplay.textContent = `${(durationMs / 1000).toFixed(1)}s`;
            }

            quizIntervalId = setInterval(() => {
                const elapsed = Date.now() - timerStartTime;
                const remaining = durationMs - elapsed;
                
                if (remaining <= 0) {
                    stopQuizTimers();
                    if (onComplete) onComplete();
                    return;
                }

                if (timerDisplay) {
                    timerDisplay.textContent = `${(remaining / 1000).toFixed(1)}s`;
                }
            }, 100); 
        }
        
        /**
         * Starts the Reveal phase countdown.
         */
        function startRevealTimer() {
            const durationMs = userSettings.revealDelay * 1000;
            startQuizInterval(durationMs, handleRevealAnswer);
            hintText.textContent = `Recalling... Answer will reveal in ${userSettings.revealDelay} seconds.`;
        }

        /**
         * Starts the Review phase countdown (auto-advance).
         */
        function startReviewTimer() {
            const durationMs = userSettings.reviewDelay * 1000;
            startQuizInterval(durationMs, handleNext);
            hintText.textContent = `Reviewing answer. Advancing to next card in ${userSettings.reviewDelay} seconds.`;
        }
        

        // --- Render Functions (View Controllers) ---

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            renderApp();
        }
        
        function handleGoToMain() {
            stopQuizTimers();
            currentMode = 'list';
            currentView = 'mode-select';
            quizFeedback = null;
            isCardFlipped = false;
            currentKanjiIndex = 0;
            renderApp();
        }

        function renderApp() {
            // 1. Dark Mode setup
            appContainer.className = isDarkMode
                ? 'dark bg-gray-900 text-white min-h-screen font-sans transition-colors duration-300'
                : 'bg-gray-50 text-gray-900 min-h-screen font-sans transition-colors duration-300';
            document.body.classList.toggle('dark', isDarkMode);
            
            // 2. Clear dynamic elements
            modeControls.innerHTML = '';
            mainContent.innerHTML = '';
            navButtons.style.display = 'none';
            stopQuizTimers(); // Ensure timers are stopped on view change
            
            // 2.5. NEW: Control Home Button visibility
            homeButton.style.display = currentView !== 'mode-select' ? 'block' : 'none';
            
            // 3. Render view-specific content
            if (currentView === 'mode-select') {
                renderModeSelect();
            } else if (currentView === 'lesson-select') {
                renderLessonSelectPage();
            } else if (currentView === 'study') {
                renderStudyView();
            }
            
            // 4. Update Header/Progress
            const totalKanji = ALL_KANJI.length;
            progressIndicator.textContent = `N5 (${totalKanji})`;

            // 5. Dark Mode SVG
            darkModeToggle.innerHTML = isDarkMode ? `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
            ` : `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            `;
        }

        function renderModeSelect() {
            modeIndicator.textContent = 'Select Study Mode';
            hintText.textContent = 'Choose how you want to interact with the N5 kanji list.';

            const modeCards = [
                { mode: 'list', title: 'List View', icon: 'ðŸ“', description: 'See all kanji details, readings, and usage examples in a clear table format.' },
                { mode: 'flashcard', title: 'Flashcard View', icon: 'ðŸƒ', description: 'Flip through individual kanji cards for focused practice, lesson by lesson.' },
                { mode: 'quiz', title: 'Automated Quiz', icon: 'â±ï¸', description: 'Test your recall using timed intervals for reveal and review, based on your settings.' },
            ];

            const cardsHtml = modeCards.map(card => `
                <button onclick="handleModeSelect('${card.mode}')" class="flex flex-col items-center p-6 bg-white dark:bg-gray-800 rounded-xl shadow-xl hover:shadow-2xl hover:scale-[1.02] transition transform duration-300 w-full text-left border-t-4 border-indigo-500">
                    <span class="text-5xl mb-3">${card.icon}</span>
                    <h3 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">${card.title}</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">${card.description}</p>
                </button>
            `).join('');

            mainContent.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">${cardsHtml}</div>`;
        }

        function renderLessonSelectPage() {
            const isQuiz = currentMode === 'quiz';
            
            modeIndicator.textContent = `${isQuiz ? 'Quiz' : (currentMode === 'flashcard' ? 'Flashcard' : 'List')} Mode Selection`;
            hintText.textContent = isQuiz 
                ? 'Select multiple lessons for a mixed quiz, or use the Settings button to configure the auto-timing.'
                : 'Select a single lesson to begin browsing.';

            // Setup radio/checkbox input types
            const inputType = isQuiz ? 'checkbox' : 'radio';
            const inputName = isQuiz ? '' : 'lessonSelection';

            const lessonCheckboxesHtml = KANJI_LESSONS.map(lesson => {
                const isChecked = selectedLessons.includes(lesson.lesson);

                return `
                    <label class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                        <input type="${inputType}" 
                               name="${inputName}"
                               data-lesson="${lesson.lesson}" 
                               class="h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                               ${isChecked ? 'checked' : ''}>
                        <span class="text-gray-900 dark:text-white font-medium">
                            Lesson ${lesson.lesson}: ${lesson.title} (${lesson.kanji.length} Kanji)
                        </span>
                    </label>
                `;
            }).join('');
            
            // Build Controls
            const settingsBtnHtml = isQuiz ? `
                <button onclick="renderSettingsModal()" class="py-2 px-4 text-sm font-semibold rounded-lg bg-gray-500 hover:bg-gray-600 text-white shadow-md transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.5.342 1.174.298 1.724-.066z" />
                    </svg>
                    Settings
                </button>
            ` : '';
            
            // Removed redundant "Back to Modes" button here. Global Home button handles it.
            modeControls.innerHTML = `
                ${settingsBtnHtml}
                <button id="startStudyButton" onclick="handleLessonSelectConfirm()" class="py-2 px-4 text-sm font-semibold rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white shadow-md transition duration-150">
                    Start ${isQuiz ? 'Quiz' : 'Study'}
                </button>
            `;


            mainContent.innerHTML = `
                <div class="w-full max-w-lg">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Select Lessons for ${currentMode.toUpperCase()}</h2>
                    <div id="lessonCheckboxes" class="grid grid-cols-2 gap-4 max-h-96 overflow-y-auto p-2 bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                        ${lessonCheckboxesHtml}
                    </div>
                </div>
            `;
        }

        function renderStudyView() {
            const totalKanji = studyKanjiList.length;
            const currentKanji = studyKanjiList[currentKanjiIndex] || {};
            
            modeIndicator.textContent = currentMode === 'quiz' ? 'Automated Quiz' : 
                                       (currentMode === 'flashcard' ? 'Flashcard Review' : 'Kanji List');
            progressIndicator.textContent = `${currentKanjiIndex + 1} / ${totalKanji}`;

            // 1. Render main content based on mode
            if (currentMode === 'list') {
                renderListView(studyKanjiList);
            } else if (currentMode === 'flashcard') {
                renderFlashcard(currentKanji);
            } else {
                renderQuizMode(currentKanji);
            }
            
            // 2. Setup navigation buttons
            navButtons.style.display = 'flex';
            
            // Label next button based on mode
            if (currentMode === 'list') {
                prevButton.textContent = 'Previous Lesson';
                nextButton.textContent = 'Next Lesson';
            } else if (currentMode === 'flashcard') {
                prevButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                        </svg>Previous Card`;
                nextButton.innerHTML = `Next Card<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                        </svg>`;
                hintText.textContent = !isCardFlipped ? 'Tap the card to reveal the readings and usage.' : '';
            } else {
                // Quiz Mode - Navigation is disabled because it's automated
                prevButton.textContent = 'Exit Quiz'; // Button to manually exit to lesson select
                nextButton.textContent = 'Quiz Active';
                nextButton.classList.add('opacity-50', 'pointer-events-none');
                prevButton.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'dark:bg-gray-700', 'dark:hover:bg-gray-600', 'text-gray-800', 'dark:text-white');
                prevButton.classList.add('bg-red-600', 'hover:bg-red-700', 'text-white');
                prevButton.disabled = false;
            }
            
            if (currentMode !== 'quiz') {
                 prevButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'text-white');
                 prevButton.classList.add('bg-gray-200', 'hover:bg-gray-300', 'dark:bg-gray-700', 'dark:hover:bg-gray-600', 'text-gray-800', 'dark:text-white');
                 nextButton.classList.remove('opacity-50', 'pointer-events-none');
                 nextButton.disabled = false;
            }

            // 3. Start interval if in Quiz Mode
            if (currentMode === 'quiz') {
                if (quizFeedback) {
                    startReviewTimer();
                } else {
                    startRevealTimer();
                }
            }
        }

        // --- Core Content Renderers (Unchanged logic) ---

        function renderListView(kanjiList) {
             const lessonData = KANJI_LESSONS.find(l => l.lesson === selectedLessons[0]) || {title: 'Mixed Lessons'};
            const lessonTitle = kanjiList.length === ALL_KANJI.length ? 'All N5 Kanji' : `Lessons: ${selectedLessons.join(', ')} (${lessonData.title})`;


            const kanjiRows = kanjiList.map((k, index) => {
                const usageHtml = k.usage.map(u => `<li>${u}</li>`).join('');

                return `
                    <tr class="group border-b border-gray-200 dark:border-gray-700 hover:bg-indigo-50 dark:hover:bg-gray-700 transition duration-150">
                        <td class="px-3 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-lg font-bold text-indigo-600 dark:text-indigo-400">${k.kanji}</td>
                        <td class="px-3 py-3 sm:px-6 sm:py-4 whitespace-nowrap text-gray-800 dark:text-gray-200">${k.meaning}</td>
                        <td class="px-3 py-3 sm:px-6 sm:py-4 whitespace-nowrap font-mono text-red-600 dark:text-red-400">${k.onyomi}</td>
                        <td class="px-3 py-3 sm:px-6 sm:py-4 whitespace-nowrap font-mono text-blue-600 dark:text-blue-400">${k.kunyomi}</td>
                        <td class="px-3 py-3 sm:px-6 sm:py-4 text-sm text-gray-600 dark:text-gray-400">
                             <ul class="list-disc list-inside space-y-1">
                                 ${usageHtml}
                             </ul>
                        </td>
                    </tr>
                `;
            }).join('');

            const listHtml = `
                <div class="w-full bg-white dark:bg-gray-800 rounded-xl shadow-lg p-3 sm:p-6">
                    <h2 class="text-xl sm:text-3xl font-extrabold text-gray-900 dark:text-white mb-4 text-center">${lessonTitle}</h2>
                    <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Kanji</th>
                                    <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Meaning</th>
                                    <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">On-yomi</th>
                                    <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Kun-yomi</th>
                                    <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Usage</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                ${kanjiRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            mainContent.innerHTML = listHtml;
            // The navigation buttons are repurposed to cycle the selected lesson's first index
        }


        function renderFlashcard(kanjiData) {
            const lesson = KANJI_LESSONS.find(l => l.kanji.some(k => k.kanji === kanjiData.kanji));
            const lessonTitle = lesson ? `Lesson ${lesson.lesson}: ${lesson.title}` : 'Mixed Kanji';
            
            const usageItems = kanjiData.usage.map(u => `<li class="text-base sm:text-lg font-medium text-gray-800 dark:text-gray-100">${u}</li>`).join('');

            const cardHtml = `
                <div id="flashcard" class="perspective-1000 w-full max-w-sm h-96 mx-auto cursor-pointer" onclick="handleFlip()">
                    <div id="cardInner" class="card-inner relative w-full h-full preserve-3d shadow-2xl rounded-2xl ${isCardFlipped ? 'flipped' : ''}">
                        
                        <!-- Front Side: Kanji and Meaning -->
                        <div class="absolute w-full h-full flex flex-col items-center justify-center p-6 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-2xl backface-hidden">
                            <p class="text-xs font-semibold text-indigo-500 dark:text-indigo-400 mb-2">${lessonTitle}</p>
                            <p class="text-7xl sm:text-9xl font-extrabold text-indigo-600 dark:text-indigo-400 mb-4">${kanjiData.kanji}</p>
                            <h2 class="text-2xl font-semibold tracking-wider text-gray-700 dark:text-gray-300">
                                ${kanjiData.meaning}
                            </h2>
                            <p class="mt-8 text-sm text-gray-500 dark:text-gray-400">Tap to see details</p>
                        </div>

                        <!-- Back Side: Readings and Usage -->
                        <div class="card-back absolute w-full h-full flex flex-col items-center justify-start p-6 bg-indigo-50 dark:bg-gray-700 text-gray-900 dark:text-white rounded-2xl backface-hidden overflow-y-auto">
                            <h3 class="text-xl font-bold mb-4 text-indigo-700 dark:text-indigo-300">${kanjiData.meaning}</h3>
                            <div class="w-full space-y-3 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md">
                                <p class="text-lg font-medium">
                                    <span class="font-bold text-gray-500 dark:text-gray-400 mr-2">On-yomi:</span>
                                    <span class="text-xl text-red-600 dark:text-red-400 font-mono">${kanjiData.onyomi}</span>
                                </p>
                                <p class="text-lg font-medium">
                                    <span class="font-bold text-gray-500 dark:text-gray-400 mr-2">Kun-yomi:</span>
                                    <span class="text-xl text-blue-600 dark:text-blue-400 font-mono">${kanjiData.kunyomi}</span>
                                </p>
                            </div>
                            
                            <div class="mt-6 p-4 bg-indigo-100 dark:bg-gray-900 rounded-lg w-full">
                                <p class="text-sm font-semibold text-indigo-800 dark:text-indigo-200 mb-1">Usage (Memorization Key):</p>
                                <ul class="space-y-2 list-disc list-inside">
                                    ${usageItems}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            mainContent.innerHTML = cardHtml;
        }

        function renderQuizMode(kanjiData) {
            const lesson = KANJI_LESSONS.find(l => l.kanji.some(k => k.kanji === kanjiData.kanji));
            const lessonTitle = lesson ? `Lesson ${lesson.lesson}: ${lesson.title}` : 'Mixed Lessons';

            let quizContentHtml;
            
            if (quizFeedback) {
                // Answer Revealed (Review Phase)
                const revealedKanji = quizFeedback.kanjiData;
                const usageItems = revealedKanji.usage.map(u => `<li class="text-base sm:text-lg font-medium text-gray-800 dark:text-gray-100">${u}</li>`).join('');

                quizContentHtml = `
                    <div class="text-center p-6 bg-green-50 dark:bg-gray-700 rounded-xl w-full">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-bold text-green-700 dark:text-green-400">Answer Revealed</h3>
                            <span id="quizTimerDisplay" class="text-2xl font-mono text-green-800 dark:text-green-300">0.0s</span>
                        </div>
                        <p class="text-7xl sm:text-9xl font-extrabold text-indigo-600 dark:text-indigo-400 mb-4">${revealedKanji.kanji}</p>
                        
                        <div class="w-full space-y-3 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md mb-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">${revealedKanji.meaning}</h2>
                            <p class="text-lg font-medium">
                                <span class="font-bold text-gray-500 dark:text-gray-400 mr-2">On-yomi:</span>
                                <span class="text-xl text-red-600 dark:text-red-400 font-mono">${revealedKanji.onyomi}</span>
                            </p>
                            <p class="text-lg font-medium">
                                <span class="font-bold text-gray-500 dark:text-gray-400 mr-2">Kun-yomi:</span>
                                <span class="text-xl text-blue-600 dark:text-blue-400 font-mono">${revealedKanji.kunyomi}</span>
                            </p>
                        </div>
                        
                        <div class="p-4 bg-indigo-100 dark:bg-gray-900 rounded-lg w-full">
                            <p class="text-sm font-semibold text-indigo-800 dark:text-indigo-200 mb-1">Usage:</p>
                            <ul class="space-y-2 list-disc list-inside text-left">
                                ${usageItems}
                            </ul>
                        </div>
                    </div>
                `;
            } else {
                // Recall State (Reveal Phase)
                quizContentHtml = `
                    <div class="text-center p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold text-gray-800 dark:text-white">Recall Phase</h3>
                            <span id="quizTimerDisplay" class="text-3xl font-mono text-indigo-600 dark:text-indigo-400">0.0s</span>
                        </div>
                        
                        <div class="text-center p-4 bg-indigo-50 dark:bg-gray-700 rounded-lg">
                            <p class="text-7xl sm:text-9xl font-extrabold text-indigo-600 dark:text-indigo-400">${kanjiData.kanji}</p>
                        </div>
                        <p class="mt-6 text-lg text-gray-700 dark:text-gray-300">What is the meaning and how is it read?</p>
                    </div>
                `;
            }

            const quizHtml = `
                <div class="max-w-md w-full p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg relative">
                    <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 text-center">${lessonTitle}</h3>
                    
                    ${quizContentHtml}
                </div>
            `;
            mainContent.innerHTML = quizHtml;
        }


        // --- Event Handlers (Navigation & Control) ---
        
        function handleModeSelect(mode) {
            currentMode = mode;
            // Reset selectedLessons to ALL to ensure the lesson select page shows everything available,
            // but the initial study list will be filtered down to Lesson 1 unless changed by the user.
            selectedLessons = KANJI_LESSONS.map(l => l.lesson);
            
            // For List/Flashcard, we enforce selection of the first lesson initially for the view logic
            if (currentMode !== 'quiz') {
                selectedLessons = [KANJI_LESSONS[0].lesson];
            }
            
            currentView = 'lesson-select';
            renderApp();
        }


        function handleLessonSelectConfirm() {
            const isQuiz = currentMode === 'quiz';
            const inputType = isQuiz ? 'checkbox' : 'radio';
            const checkboxes = document.querySelectorAll(`#lessonCheckboxes input[type="${inputType}"]`);
            
            const newlySelectedLessons = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => parseInt(cb.dataset.lesson));
            
            if (newlySelectedLessons.length === 0) {
                 // For List and Flashcard, if nothing is selected, force Lesson 1
                 if (!isQuiz) {
                    newlySelectedLessons.push(KANJI_LESSONS[0].lesson);
                 } else {
                    // Using custom message box instead of alert()
                    (function(){
                        const errorMsg = 'You must select at least one lesson for the Quiz.';
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'fixed top-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-xl z-50';
                        errorDiv.textContent = errorMsg;
                        document.body.appendChild(errorDiv);
                        setTimeout(() => errorDiv.remove(), 3000);
                    })();
                    return;
                 }
            }
            
            // For List/Flashcard, ensure only one lesson is selected
            if (!isQuiz && newlySelectedLessons.length > 1) {
                // If somehow multiple are checked, force single selection (only the first one)
                selectedLessons = [newlySelectedLessons[0]];
            } else {
                selectedLessons = newlySelectedLessons;
            }

            compileStudyList();
            
            if (studyKanjiList.length === 0) {
                 // Using custom message box instead of alert()
                 (function(){
                    const errorMsg = 'Selected lessons contain no kanji. Please check your selection.';
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'fixed top-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-xl z-50';
                    errorDiv.textContent = errorMsg;
                    document.body.appendChild(errorDiv);
                    setTimeout(() => errorDiv.remove(), 3000);
                })();
                 return;
            }

            currentKanjiIndex = 0;
            quizFeedback = null; 
            currentView = 'study';
            renderApp();
        }

        function handleRevealAnswer() {
            stopQuizTimers();
            
            quizFeedback = {
                isRevealed: true,
                kanjiData: studyKanjiList[currentKanjiIndex],
            };
            
            // Re-render, which triggers startReviewTimer
            renderApp(); 
        }


        function handleNext() {
            isCardFlipped = false;
            quizFeedback = null; 
            stopQuizTimers(); 
            
            const totalLessons = KANJI_LESSONS.length;

            if (currentMode === 'list' || currentMode === 'flashcard') {
                // Cycle through lessons (using the current single selected lesson as the base)
                const currentLessonNumber = selectedLessons[0];
                const currentLessonIndex = KANJI_LESSONS.findIndex(l => l.lesson === currentLessonNumber);
                
                const nextIndex = (currentLessonIndex + 1) % totalLessons;
                
                selectedLessons = [KANJI_LESSONS[nextIndex].lesson];
                compileStudyList();
            } else { // Quiz mode 
                 if (currentKanjiIndex < studyKanjiList.length - 1) {
                    currentKanjiIndex++;
                 } else {
                    // Quiz Finished
                    (function(){
                        const finishMsg = `Quiz finished! You completed ${studyKanjiList.length} kanji. Returning to setup.`;
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'fixed top-4 right-4 bg-green-600 text-white p-4 rounded-lg shadow-xl z-50';
                        msgDiv.textContent = finishMsg;
                        document.body.appendChild(msgDiv);
                        setTimeout(() => msgDiv.remove(), 4000);
                    })();
                    currentView = 'lesson-select'; // Go back to lesson selection
                 }
            }
            
            renderApp();
        }

        function handlePrev() {
            isCardFlipped = false;
            quizFeedback = null;
            stopQuizTimers(); 
            
            const totalLessons = KANJI_LESSONS.length;

            if (currentMode === 'list' || currentMode === 'flashcard') {
                // Cycle through lessons (using the current single selected lesson as the base)
                const currentLessonNumber = selectedLessons[0];
                const currentLessonIndex = KANJI_LESSONS.findIndex(l => l.lesson === currentLessonNumber);
                
                const prevIndex = (currentLessonIndex - 1 + totalLessons) % totalLessons;
                
                selectedLessons = [KANJI_LESSONS[prevIndex].lesson];
                compileStudyList();
            } else {
                // Quiz Mode: Back button goes to lesson select
                currentView = 'lesson-select'; 
            }

            renderApp();
        }
        
        function handleFlip() {
            if (currentMode === 'flashcard') {
                isCardFlipped = !isCardFlipped;
                renderApp();
            }
        }
        
        // --- Settings Modal Functions ---

        function renderSettingsModal() {
            revealDelayInput.value = userSettings.revealDelay;
            reviewDelayInput.value = userSettings.reviewDelay;
            settingsModal.style.display = 'flex';
        }

        function handleSaveSettings() {
            const newRevealDelay = parseInt(revealDelayInput.value);
            const newReviewDelay = parseInt(reviewDelayInput.value);
            
            if (isNaN(newRevealDelay) || newRevealDelay < 1 || isNaN(newReviewDelay) || newReviewDelay < 1) {
                // Using an inline function to avoid global alert() issue
                (function(){
                    const errorMsg = 'Both delay times must be positive whole numbers.';
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'fixed top-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-xl z-50';
                    errorDiv.textContent = errorMsg;
                    document.body.appendChild(errorDiv);
                    setTimeout(() => errorDiv.remove(), 3000);
                })();
                return;
            }

            userSettings.revealDelay = newRevealDelay;
            userSettings.reviewDelay = newReviewDelay;
            settingsModal.style.display = 'none';
            renderApp();
        }

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            }
            
            // Initial setup for default selection (Lesson 1)
            selectedLessons = [1];
            compileStudyList();

            // Attach static event listeners
            darkModeToggle.addEventListener('click', toggleDarkMode);
            homeButton.addEventListener('click', handleGoToMain); // ATTACH HOME BUTTON LISTENER
            
            // Settings modal events
            closeSettingsModalButton.addEventListener('click', () => settingsModal.style.display = 'none');
            saveSettingsButton.addEventListener('click', handleSaveSettings);

            // Main navigation
            document.getElementById('nextButton').addEventListener('click', handleNext);
            document.getElementById('prevButton').addEventListener('click', handlePrev);
            
            // Initial Render
            renderApp();
        });
    </script>
</body>
</html>
